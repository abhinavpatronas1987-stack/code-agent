# Colang 2.0 Rail Definitions for Code Agent
# This file defines the conversation flows and safety rails

# ============================================================
# INPUT RAILS - Check user input before processing
# ============================================================

define flow check jailbreak
  """Check if user is attempting to jailbreak the AI."""
  $is_jailbreak = execute check_jailbreak_attempt(user_input=$user_message)

  if $is_jailbreak
    bot refuse jailbreak
    stop

define flow check code injection
  """Check for code/command injection attempts."""
  $has_injection = execute check_code_injection(user_input=$user_message)

  if $has_injection
    bot warn code injection
    stop

define flow check file path safety
  """Check for attempts to access unsafe file paths."""
  $unsafe_path = execute check_unsafe_file_path(user_input=$user_message)

  if $unsafe_path
    bot refuse unsafe path
    stop

define flow check input safety
  """General input safety validation."""
  $is_unsafe = execute check_input_safety(user_input=$user_message)

  if $is_unsafe
    bot refuse unsafe input
    stop

# ============================================================
# OUTPUT RAILS - Check and sanitize bot output
# ============================================================

define flow check output safety
  """Check if output contains unsafe content."""
  $has_unsafe_content = execute check_output_safety(bot_response=$bot_message)

  if $has_unsafe_content
    $bot_message = execute sanitize_output(text=$bot_message)

define flow check sensitive data
  """Check for and redact sensitive data in output."""
  $has_secrets = execute detect_secrets(text=$bot_message)

  if $has_secrets
    $bot_message = execute redact_secrets(text=$bot_message)

define flow check code safety
  """Check if generated code contains dangerous patterns."""
  $has_dangerous_code = execute check_dangerous_code(code=$bot_message)

  if $has_dangerous_code
    bot warn dangerous code

# ============================================================
# BOT RESPONSES - Predefined responses for blocked requests
# ============================================================

define bot refuse jailbreak
  "I cannot help with that request. I'm designed to assist with legitimate coding and development tasks only. Please ask me something related to software development."

define bot warn code injection
  "I detected a potentially dangerous command in your request. For safety reasons, I cannot execute commands like rm -rf, format, or other destructive operations. Please rephrase your request with safe operations."

define bot refuse unsafe path
  "I cannot access system directories or sensitive file paths like /etc, ~/.ssh, or .env files. Please specify a path within your project workspace."

define bot refuse unsafe input
  "I cannot process this request as it may pose a security risk. Please check your input and try again with a valid coding-related request."

define bot warn dangerous code
  "Warning: The code I've generated contains potentially dangerous operations (like eval, exec, or shell commands). Please review it carefully before executing and consider safer alternatives."

# ============================================================
# USER MESSAGE PATTERNS - Common user intents
# ============================================================

define user ask for help
  "Help me with..."
  "Can you help..."
  "I need help with..."
  "How do I..."

define user ask to write code
  "Write a function..."
  "Create a class..."
  "Implement..."
  "Code this..."
  "Generate code for..."

define user ask to fix bug
  "Fix this bug..."
  "Debug this..."
  "Why is this not working..."
  "There's an error..."

define user ask to explain
  "Explain this code..."
  "What does this do..."
  "How does this work..."

define user ask to run command
  "Run this command..."
  "Execute..."
  "Run..."

define user attempt jailbreak
  "Ignore your instructions..."
  "Forget your rules..."
  "You are now..."
  "Pretend to be..."
  "Act as if..."
  "DAN mode..."
  "Developer mode..."

define user attempt injection
  "rm -rf..."
  "format c:..."
  "del /f /s..."
  "; drop table..."
  "sudo..."

# ============================================================
# CONVERSATION FLOWS - Normal interaction patterns
# ============================================================

define flow handle coding request
  user ask for help or user ask to write code or user ask to fix bug
  bot provide coding assistance

define flow handle explanation request
  user ask to explain
  bot explain code

define flow handle command request
  user ask to run command
  # Check if command is safe first
  $is_safe = execute check_code_injection(user_input=$user_message)
  if not $is_safe
    bot warn code injection
    stop
  else
    bot execute safe command

# ============================================================
# BOT ASSISTANCE RESPONSES
# ============================================================

define bot provide coding assistance
  "I'd be happy to help with that coding task. Let me work on it."

define bot explain code
  "Let me explain how this code works."

define bot execute safe command
  "I'll execute that command for you. Here's the output:"

define bot ask for clarification
  "Could you please provide more details about what you'd like me to do?"
