<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Security & Guardrails Implementation Guide - Code Agent</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        :root {
            --primary: #ef4444;
            --primary-light: #f87171;
            --secondary: #10b981;
            --accent: #f59e0b;
            --nvidia: #76b900;
            --guardrails: #6366f1;
            --langchain: #2dd4bf;
            --bg-dark: #0f172a;
            --bg-darker: #020617;
            --bg-card: rgba(30, 41, 59, 0.9);
            --bg-glass: rgba(255, 255, 255, 0.03);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: rgba(148, 163, 184, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg-darker);
            color: var(--text-primary);
            line-height: 1.7;
        }

        .bg-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background:
                radial-gradient(circle at 20% 20%, rgba(239, 68, 68, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 80% 80%, rgba(16, 185, 129, 0.06) 0%, transparent 40%);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 60px 40px;
            margin-bottom: 50px;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(16, 185, 129, 0.1));
            border-radius: 24px;
            border: 1px solid var(--primary);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: 'üõ°Ô∏è';
            position: absolute;
            top: 20px;
            right: 40px;
            font-size: 5rem;
            opacity: 0.15;
        }

        .header h1 {
            font-size: 2.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, #ef4444, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.2rem;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Section */
        .section {
            margin-bottom: 50px;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .section-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .section-header h2 {
            font-size: 1.6rem;
        }

        /* Framework Cards */
        .framework-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .framework-card {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .framework-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .framework-card.nvidia { border-color: var(--nvidia); }
        .framework-card.guardrails-ai { border-color: var(--guardrails); }
        .framework-card.langchain { border-color: var(--langchain); }

        .framework-header {
            padding: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .framework-card.nvidia .framework-header { background: rgba(118, 185, 0, 0.1); }
        .framework-card.guardrails-ai .framework-header { background: rgba(99, 102, 241, 0.1); }
        .framework-card.langchain .framework-header { background: rgba(45, 212, 191, 0.1); }

        .framework-logo {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            font-weight: 800;
        }

        .framework-card.nvidia .framework-logo { background: var(--nvidia); }
        .framework-card.guardrails-ai .framework-logo { background: var(--guardrails); }
        .framework-card.langchain .framework-logo { background: var(--langchain); }

        .framework-info h3 {
            font-size: 1.3rem;
            margin-bottom: 5px;
        }

        .framework-info span {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .framework-badge {
            margin-left: auto;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-recommended {
            background: rgba(16, 185, 129, 0.2);
            color: var(--secondary);
        }

        .badge-popular {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent);
        }

        .framework-body {
            padding: 25px;
        }

        .framework-body p {
            color: var(--text-secondary);
            margin-bottom: 20px;
            font-size: 0.95rem;
        }

        .feature-list {
            list-style: none;
            margin-bottom: 20px;
        }

        .feature-list li {
            padding: 8px 0;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .feature-list li::before {
            content: '‚úì';
            color: var(--secondary);
            font-weight: bold;
        }

        .install-cmd {
            background: #0d1117;
            border-radius: 10px;
            padding: 15px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: var(--langchain);
        }

        /* Comparison Table */
        .comparison-table {
            width: 100%;
            background: var(--bg-card);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--border);
            margin-bottom: 40px;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 18px 20px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .comparison-table th {
            background: rgba(239, 68, 68, 0.1);
            font-weight: 600;
        }

        .comparison-table tr:last-child td {
            border-bottom: none;
        }

        .comparison-table td {
            color: var(--text-secondary);
        }

        .check { color: var(--secondary); }
        .cross { color: var(--primary); }

        /* Implementation Guide */
        .impl-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .impl-section h3 {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }

        .impl-section h3 span {
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .code-block {
            background: #0d1117;
            border-radius: 12px;
            padding: 20px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            line-height: 1.7;
            margin: 15px 0;
            border: 1px solid var(--border);
        }

        .code-block .comment { color: #8b949e; }
        .code-block .keyword { color: #ff7b72; }
        .code-block .string { color: #a5d6ff; }
        .code-block .function { color: #d2a8ff; }
        .code-block .decorator { color: #79c0ff; }
        .code-block .class { color: #ffa657; }

        .step-indicator {
            display: inline-block;
            background: var(--primary);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-right: 10px;
        }

        /* Guardrails Types */
        .guardrail-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .guardrail-type {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 25px;
            transition: all 0.3s ease;
        }

        .guardrail-type:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
        }

        .guardrail-type h4 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            font-size: 1.1rem;
        }

        .guardrail-type h4 span {
            font-size: 1.3rem;
        }

        .guardrail-type p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .guardrail-type .examples {
            background: var(--bg-glass);
            border-radius: 8px;
            padding: 12px;
            font-size: 0.85rem;
            color: var(--accent);
        }

        /* Recommendation Box */
        .recommendation {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(6, 182, 212, 0.1));
            border: 1px solid var(--secondary);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
        }

        .recommendation h3 {
            color: var(--secondary);
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .recommendation p {
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .recommendation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .rec-item {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
        }

        .rec-item h4 {
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .rec-item p {
            font-size: 0.85rem;
            margin: 0;
        }

        /* Architecture Diagram */
        .architecture {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 40px;
            text-align: center;
        }

        .architecture h3 {
            margin-bottom: 30px;
            font-size: 1.4rem;
        }

        .arch-flow {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .arch-node {
            background: var(--bg-glass);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px 30px;
            text-align: center;
            min-width: 140px;
        }

        .arch-node.input { border-color: var(--langchain); }
        .arch-node.guardrail { border-color: var(--primary); background: rgba(239, 68, 68, 0.1); }
        .arch-node.agent { border-color: var(--guardrails); }
        .arch-node.output { border-color: var(--secondary); }

        .arch-node .icon {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }

        .arch-node h4 {
            font-size: 0.9rem;
        }

        .arch-node span {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .arch-arrow {
            font-size: 1.5rem;
            color: var(--primary);
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 40px;
            margin-top: 40px;
            border-top: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .footer a {
            color: var(--primary);
            text-decoration: none;
        }

        .source-links {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
        }

        .source-links h4 {
            margin-bottom: 15px;
            color: var(--accent);
        }

        .source-links a {
            display: block;
            color: var(--langchain);
            text-decoration: none;
            padding: 8px 0;
            font-size: 0.9rem;
        }

        .source-links a:hover {
            color: var(--text-primary);
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 2rem; }
            .framework-grid { grid-template-columns: 1fr; }
            .arch-flow { flex-direction: column; }
            .arch-arrow { transform: rotate(90deg); }
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>AI Security & Guardrails Guide</h1>
            <p>Complete implementation guide for adding security guardrails to your Code Agent project</p>
        </header>

        <!-- What are Guardrails -->
        <section class="section">
            <div class="section-header">
                <div class="section-icon">üõ°Ô∏è</div>
                <h2>What are AI Guardrails?</h2>
            </div>

            <div class="guardrail-types">
                <div class="guardrail-type">
                    <h4><span>üéØ</span> Topical Guardrails</h4>
                    <p>Keep conversations on-topic. Prevent the agent from discussing unrelated subjects.</p>
                    <div class="examples">Example: Block discussions about politics, religion when user asks about code</div>
                </div>

                <div class="guardrail-type">
                    <h4><span>üîí</span> Safety Guardrails</h4>
                    <p>Prevent harmful, toxic, or inappropriate content generation.</p>
                    <div class="examples">Example: Block generation of malicious code, offensive language</div>
                </div>

                <div class="guardrail-type">
                    <h4><span>üõ°Ô∏è</span> Security Guardrails</h4>
                    <p>Protect against prompt injection, jailbreaks, and malicious inputs.</p>
                    <div class="examples">Example: Detect "ignore previous instructions" attacks</div>
                </div>

                <div class="guardrail-type">
                    <h4><span>üìã</span> Input Validation</h4>
                    <p>Validate and sanitize user inputs before processing.</p>
                    <div class="examples">Example: Block SQL injection, path traversal attempts</div>
                </div>

                <div class="guardrail-type">
                    <h4><span>üì§</span> Output Validation</h4>
                    <p>Verify LLM outputs meet quality and safety standards.</p>
                    <div class="examples">Example: Check for PII, validate JSON format</div>
                </div>

                <div class="guardrail-type">
                    <h4><span>üë§</span> PII Detection</h4>
                    <p>Detect and redact personally identifiable information.</p>
                    <div class="examples">Example: Mask emails, credit cards, phone numbers</div>
                </div>
            </div>
        </section>

        <!-- Framework Comparison -->
        <section class="section">
            <div class="section-header">
                <div class="section-icon">üìä</div>
                <h2>Top Guardrail Frameworks</h2>
            </div>

            <div class="framework-grid">
                <!-- NeMo Guardrails -->
                <div class="framework-card nvidia">
                    <div class="framework-header">
                        <div class="framework-logo">N</div>
                        <div class="framework-info">
                            <h3>NeMo Guardrails</h3>
                            <span>by NVIDIA</span>
                        </div>
                        <span class="framework-badge badge-recommended">Recommended</span>
                    </div>
                    <div class="framework-body">
                        <p>Open-source toolkit for adding programmable guardrails to LLM applications. Supports topical, safety, and security guardrails with a unique Colang DSL.</p>
                        <ul class="feature-list">
                            <li>Programmable dialog flows with Colang</li>
                            <li>Jailbreak & prompt injection detection</li>
                            <li>Hallucination prevention (RAG)</li>
                            <li>LangChain & LlamaIndex integration</li>
                            <li>Multi-agent support</li>
                            <li>GPU acceleration for low latency</li>
                        </ul>
                        <div class="install-cmd">pip install nemoguardrails</div>
                    </div>
                </div>

                <!-- Guardrails AI -->
                <div class="framework-card guardrails-ai">
                    <div class="framework-header">
                        <div class="framework-logo">G</div>
                        <div class="framework-info">
                            <h3>Guardrails AI</h3>
                            <span>Open Source</span>
                        </div>
                        <span class="framework-badge badge-popular">Popular</span>
                    </div>
                    <div class="framework-body">
                        <p>Programmatic framework for output validation with pre-built validators. Focus on ensuring LLM outputs meet specific criteria.</p>
                        <ul class="feature-list">
                            <li>100+ pre-built validators on Hub</li>
                            <li>Custom validator creation</li>
                            <li>Structured output enforcement</li>
                            <li>Automatic retries on failure</li>
                            <li>Python & JavaScript support</li>
                            <li>NeMo integration available</li>
                        </ul>
                        <div class="install-cmd">pip install guardrails-ai</div>
                    </div>
                </div>

                <!-- LangChain -->
                <div class="framework-card langchain">
                    <div class="framework-header">
                        <div class="framework-logo">ü¶ú</div>
                        <div class="framework-info">
                            <h3>LangChain Guardrails</h3>
                            <span>Built-in</span>
                        </div>
                    </div>
                    <div class="framework-body">
                        <p>Built-in middleware for PII detection, human approval flows, and content moderation within the LangChain ecosystem.</p>
                        <ul class="feature-list">
                            <li>PII detection middleware</li>
                            <li>Human-in-the-loop approval</li>
                            <li>Content moderation</li>
                            <li>Native chain integration</li>
                            <li>Tool call restrictions</li>
                            <li>Output parsers with validation</li>
                        </ul>
                        <div class="install-cmd">pip install langchain langchain-experimental</div>
                    </div>
                </div>
            </div>

            <!-- Comparison Table -->
            <table class="comparison-table">
                <tr>
                    <th>Feature</th>
                    <th>NeMo Guardrails</th>
                    <th>Guardrails AI</th>
                    <th>LangChain</th>
                </tr>
                <tr>
                    <td>Input Validation</td>
                    <td class="check">‚úì Full</td>
                    <td class="check">‚úì Basic</td>
                    <td class="check">‚úì PII only</td>
                </tr>
                <tr>
                    <td>Output Validation</td>
                    <td class="check">‚úì Yes</td>
                    <td class="check">‚úì Excellent</td>
                    <td class="check">‚úì Parsers</td>
                </tr>
                <tr>
                    <td>Jailbreak Detection</td>
                    <td class="check">‚úì Built-in</td>
                    <td class="cross">‚úó Manual</td>
                    <td class="cross">‚úó No</td>
                </tr>
                <tr>
                    <td>Dialog Flows</td>
                    <td class="check">‚úì Colang DSL</td>
                    <td class="cross">‚úó No</td>
                    <td class="cross">‚úó No</td>
                </tr>
                <tr>
                    <td>Human Approval</td>
                    <td class="check">‚úì Yes</td>
                    <td class="cross">‚úó No</td>
                    <td class="check">‚úì Built-in</td>
                </tr>
                <tr>
                    <td>Agno Compatible</td>
                    <td class="check">‚úì Wrapper</td>
                    <td class="check">‚úì Wrapper</td>
                    <td class="cross">‚úó Separate</td>
                </tr>
            </table>
        </section>

        <!-- Recommendation -->
        <section class="recommendation">
            <h3>üéØ Recommended Approach for Code Agent</h3>
            <p>Based on your project architecture using Agno framework, here's the recommended combination:</p>
            <div class="recommendation-grid">
                <div class="rec-item">
                    <h4>1. NeMo Guardrails (Primary)</h4>
                    <p>Use for input filtering, jailbreak detection, and dialog control. Wraps around your Agno agent.</p>
                </div>
                <div class="rec-item">
                    <h4>2. Guardrails AI (Output)</h4>
                    <p>Use for output validation - ensuring code snippets are valid, no PII in responses.</p>
                </div>
                <div class="rec-item">
                    <h4>3. Custom Validators</h4>
                    <p>Add project-specific rules like path validation, command sanitization.</p>
                </div>
            </div>
        </section>

        <!-- Architecture -->
        <section class="architecture">
            <h3>üèóÔ∏è Guardrails Architecture in Code Agent</h3>
            <div class="arch-flow">
                <div class="arch-node input">
                    <div class="icon">üë§</div>
                    <h4>User Input</h4>
                    <span>CLI / API</span>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="arch-node guardrail">
                    <div class="icon">üõ°Ô∏è</div>
                    <h4>Input Guard</h4>
                    <span>NeMo Rails</span>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="arch-node agent">
                    <div class="icon">ü§ñ</div>
                    <h4>CodingAgent</h4>
                    <span>Agno + LLM</span>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="arch-node guardrail">
                    <div class="icon">‚úÖ</div>
                    <h4>Output Guard</h4>
                    <span>Guardrails AI</span>
                </div>
                <div class="arch-arrow">‚Üí</div>
                <div class="arch-node output">
                    <div class="icon">üì§</div>
                    <h4>Response</h4>
                    <span>Validated</span>
                </div>
            </div>
        </section>

        <!-- Implementation Guide -->
        <section class="section">
            <div class="section-header">
                <div class="section-icon">üíª</div>
                <h2>Implementation Guide</h2>
            </div>

            <!-- Step 1: Install -->
            <div class="impl-section">
                <h3><span>1</span> Install Dependencies</h3>
                <div class="code-block">
<pre><span class="comment"># Install guardrail frameworks</span>
pip install nemoguardrails
pip install guardrails-ai

<span class="comment"># Initialize Guardrails AI Hub</span>
guardrails hub install hub://guardrails/toxic_language
guardrails hub install hub://guardrails/detect_pii
guardrails hub install hub://guardrails/valid_python</pre>
                </div>
            </div>

            <!-- Step 2: NeMo Config -->
            <div class="impl-section">
                <h3><span>2</span> Create NeMo Guardrails Config</h3>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">Create a <code>config/</code> folder with these files:</p>

                <p style="color: var(--accent); font-weight: 600; margin: 15px 0 10px;">config/config.yml</p>
                <div class="code-block">
<pre><span class="keyword">models</span>:
  - <span class="keyword">type</span>: main
    <span class="keyword">engine</span>: openai  <span class="comment"># or anthropic</span>
    <span class="keyword">model</span>: gpt-4

<span class="keyword">rails</span>:
  <span class="keyword">input</span>:
    <span class="keyword">flows</span>:
      - self check input  <span class="comment"># Check for jailbreaks</span>
      - check blocked terms

  <span class="keyword">output</span>:
    <span class="keyword">flows</span>:
      - self check output  <span class="comment"># Validate response</span>
      - check sensitive data</pre>
                </div>

                <p style="color: var(--accent); font-weight: 600; margin: 15px 0 10px;">config/rails.co (Colang file)</p>
                <div class="code-block">
<pre><span class="comment"># Define what the bot should NOT do</span>
<span class="keyword">define</span> user ask about harmful code
  <span class="string">"write malware"</span>
  <span class="string">"create a virus"</span>
  <span class="string">"hack into"</span>
  <span class="string">"exploit vulnerability"</span>

<span class="keyword">define</span> bot refuse harmful request
  <span class="string">"I cannot help with creating harmful code or security exploits."</span>

<span class="keyword">define</span> flow
  <span class="keyword">user</span> ask about harmful code
  <span class="keyword">bot</span> refuse harmful request

<span class="comment"># Block prompt injection attempts</span>
<span class="keyword">define</span> user prompt injection
  <span class="string">"ignore previous instructions"</span>
  <span class="string">"forget your rules"</span>
  <span class="string">"you are now"</span>
  <span class="string">"pretend to be"</span>

<span class="keyword">define</span> bot block injection
  <span class="string">"I cannot change my core instructions."</span>

<span class="keyword">define</span> flow
  <span class="keyword">user</span> prompt injection
  <span class="keyword">bot</span> block injection</pre>
                </div>
            </div>

            <!-- Step 3: Integrate with Agno -->
            <div class="impl-section">
                <h3><span>3</span> Integrate NeMo with Agno Agent</h3>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">Create <code>src/core/guardrails.py</code>:</p>
                <div class="code-block">
<pre><span class="keyword">from</span> nemoguardrails <span class="keyword">import</span> RailsConfig, LLMRails
<span class="keyword">from</span> typing <span class="keyword">import</span> Optional

<span class="keyword">class</span> <span class="class">GuardrailsManager</span>:
    <span class="string">"""Manages input/output guardrails for the agent."""</span>

    <span class="keyword">def</span> <span class="function">__init__</span>(self, config_path: str = <span class="string">"config"</span>):
        <span class="comment"># Load NeMo Guardrails configuration</span>
        self.config = RailsConfig.from_path(config_path)
        self.rails = LLMRails(self.config)

    <span class="keyword">async def</span> <span class="function">check_input</span>(self, user_message: str) -> tuple[bool, Optional[str]]:
        <span class="string">"""
        Check if input is safe to process.

        Returns:
            (is_safe, blocked_reason)
        """</span>
        <span class="keyword">try</span>:
            <span class="comment"># Run input through guardrails</span>
            response = <span class="keyword">await</span> self.rails.generate_async(
                messages=[{<span class="string">"role"</span>: <span class="string">"user"</span>, <span class="string">"content"</span>: user_message}]
            )

            <span class="comment"># Check if guardrails blocked the input</span>
            <span class="keyword">if</span> response.get(<span class="string">"blocked"</span>):
                <span class="keyword">return</span> <span class="keyword">False</span>, response.get(<span class="string">"reason"</span>)

            <span class="keyword">return</span> <span class="keyword">True</span>, <span class="keyword">None</span>

        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:
            <span class="comment"># Log error but don't block on guardrail failure</span>
            logger.error(f<span class="string">"Guardrail check failed: {e}"</span>)
            <span class="keyword">return</span> <span class="keyword">True</span>, <span class="keyword">None</span>

    <span class="keyword">async def</span> <span class="function">validate_output</span>(self, response: str) -> tuple[bool, str]:
        <span class="string">"""
        Validate agent output before sending to user.

        Returns:
            (is_valid, sanitized_response)
        """</span>
        <span class="comment"># Run output validation</span>
        result = <span class="keyword">await</span> self.rails.generate_async(
            messages=[{<span class="string">"role"</span>: <span class="string">"assistant"</span>, <span class="string">"content"</span>: response}]
        )

        <span class="keyword">return</span> <span class="keyword">True</span>, result.get(<span class="string">"content"</span>, response)</pre>
                </div>
            </div>

            <!-- Step 4: Output Validation -->
            <div class="impl-section">
                <h3><span>4</span> Add Output Validation with Guardrails AI</h3>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">Create <code>src/core/output_validator.py</code>:</p>
                <div class="code-block">
<pre><span class="keyword">from</span> guardrails <span class="keyword">import</span> Guard
<span class="keyword">from</span> guardrails.hub <span class="keyword">import</span> ToxicLanguage, DetectPII, ValidPython

<span class="keyword">class</span> <span class="class">OutputValidator</span>:
    <span class="string">"""Validates LLM outputs using Guardrails AI."""</span>

    <span class="keyword">def</span> <span class="function">__init__</span>(self):
        <span class="comment"># Create guards for different validation types</span>
        self.toxicity_guard = Guard().use(
            ToxicLanguage(threshold=<span class="number">0.8</span>, on_fail=<span class="string">"filter"</span>)
        )

        self.pii_guard = Guard().use(
            DetectPII(
                pii_entities=[<span class="string">"EMAIL"</span>, <span class="string">"PHONE"</span>, <span class="string">"SSN"</span>, <span class="string">"CREDIT_CARD"</span>],
                on_fail=<span class="string">"fix"</span>  <span class="comment"># Automatically redact PII</span>
            )
        )

        self.python_guard = Guard().use(
            ValidPython(on_fail=<span class="string">"noop"</span>)  <span class="comment"># Check if code is valid</span>
        )

    <span class="keyword">def</span> <span class="function">validate_response</span>(self, response: str) -> dict:
        <span class="string">"""
        Run all validators on response.

        Returns:
            {
                "is_valid": bool,
                "sanitized": str,
                "issues": list
            }
        """</span>
        issues = []
        sanitized = response

        <span class="comment"># Check for toxic content</span>
        <span class="keyword">try</span>:
            result = self.toxicity_guard.validate(sanitized)
            <span class="keyword">if not</span> result.validation_passed:
                issues.append(<span class="string">"Toxic content detected"</span>)
                sanitized = result.validated_output
        <span class="keyword">except</span>:
            <span class="keyword">pass</span>

        <span class="comment"># Check for PII</span>
        <span class="keyword">try</span>:
            result = self.pii_guard.validate(sanitized)
            <span class="keyword">if not</span> result.validation_passed:
                issues.append(<span class="string">"PII detected and redacted"</span>)
                sanitized = result.validated_output
        <span class="keyword">except</span>:
            <span class="keyword">pass</span>

        <span class="keyword">return</span> {
            <span class="string">"is_valid"</span>: len(issues) == <span class="number">0</span>,
            <span class="string">"sanitized"</span>: sanitized,
            <span class="string">"issues"</span>: issues
        }</pre>
                </div>
            </div>

            <!-- Step 5: Integrate into Agent -->
            <div class="impl-section">
                <h3><span>5</span> Update CodingAgent with Guardrails</h3>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">Modify <code>src/agents/coding_agent.py</code>:</p>
                <div class="code-block">
<pre><span class="keyword">from</span> src.core.guardrails <span class="keyword">import</span> GuardrailsManager
<span class="keyword">from</span> src.core.output_validator <span class="keyword">import</span> OutputValidator

<span class="keyword">class</span> <span class="class">CodingAgent</span>:
    <span class="keyword">def</span> <span class="function">__init__</span>(self, session_id: str, ...):
        <span class="comment"># Existing initialization...</span>
        self.agent = Agent(...)

        <span class="comment"># Add guardrails</span>
        self.guardrails = GuardrailsManager()
        self.output_validator = OutputValidator()

    <span class="keyword">async def</span> <span class="function">run</span>(self, message: str, stream: bool = <span class="keyword">True</span>):
        <span class="comment"># Step 1: Check input with guardrails</span>
        is_safe, blocked_reason = <span class="keyword">await</span> self.guardrails.check_input(message)

        <span class="keyword">if not</span> is_safe:
            <span class="keyword">yield</span> f<span class="string">"‚ö†Ô∏è Request blocked: {blocked_reason}"</span>
            <span class="keyword">return</span>

        <span class="comment"># Step 2: Run agent normally</span>
        response_text = <span class="string">""</span>
        <span class="keyword">async for</span> chunk <span class="keyword">in</span> self.agent.run(message, stream=stream):
            response_text += chunk.content
            <span class="keyword">yield</span> chunk

        <span class="comment"># Step 3: Validate output</span>
        validation = self.output_validator.validate_response(response_text)

        <span class="keyword">if not</span> validation[<span class="string">"is_valid"</span>]:
            logger.warning(f<span class="string">"Output issues: {validation['issues']}"</span>)
            <span class="comment"># Could re-yield sanitized version if needed</span></pre>
                </div>
            </div>

            <!-- Step 6: Custom Validators -->
            <div class="impl-section">
                <h3><span>6</span> Add Custom Security Validators</h3>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">Create <code>src/core/security_validators.py</code>:</p>
                <div class="code-block">
<pre><span class="keyword">import</span> re
<span class="keyword">from</span> pathlib <span class="keyword">import</span> Path

<span class="keyword">class</span> <span class="class">SecurityValidators</span>:
    <span class="string">"""Custom security validators for Code Agent."""</span>

    <span class="comment"># Dangerous command patterns</span>
    DANGEROUS_COMMANDS = [
        r<span class="string">"rm\s+-rf\s+/"</span>,           <span class="comment"># rm -rf /</span>
        r<span class="string">":\(\)\s*\{\s*:\|:\s*&\s*\}"</span>,  <span class="comment"># Fork bomb</span>
        r<span class="string">"mkfs\."</span>,                   <span class="comment"># Format disk</span>
        r<span class="string">"dd\s+if=.*of=/dev/"</span>,       <span class="comment"># Write to device</span>
        r<span class="string">">\s*/dev/sd"</span>,               <span class="comment"># Redirect to disk</span>
    ]

    <span class="comment"># Prompt injection patterns</span>
    INJECTION_PATTERNS = [
        r<span class="string">"ignore\s+(all\s+)?previous"</span>,
        r<span class="string">"forget\s+(your|all)\s+(rules|instructions)"</span>,
        r<span class="string">"you\s+are\s+now\s+a"</span>,
        r<span class="string">"pretend\s+(to\s+be|you're)"</span>,
        r<span class="string">"act\s+as\s+if"</span>,
        r<span class="string">"jailbreak"</span>,
        r<span class="string">"DAN\s+mode"</span>,
    ]

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">check_dangerous_command</span>(cls, command: str) -> tuple[bool, str]:
        <span class="string">"""Check if command is potentially dangerous."""</span>
        <span class="keyword">for</span> pattern <span class="keyword">in</span> cls.DANGEROUS_COMMANDS:
            <span class="keyword">if</span> re.search(pattern, command, re.IGNORECASE):
                <span class="keyword">return</span> <span class="keyword">False</span>, f<span class="string">"Dangerous command pattern detected"</span>
        <span class="keyword">return</span> <span class="keyword">True</span>, <span class="string">""</span>

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">check_prompt_injection</span>(cls, text: str) -> tuple[bool, str]:
        <span class="string">"""Detect prompt injection attempts."""</span>
        <span class="keyword">for</span> pattern <span class="keyword">in</span> cls.INJECTION_PATTERNS:
            <span class="keyword">if</span> re.search(pattern, text, re.IGNORECASE):
                <span class="keyword">return</span> <span class="keyword">False</span>, <span class="string">"Potential prompt injection detected"</span>
        <span class="keyword">return</span> <span class="keyword">True</span>, <span class="string">""</span>

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">validate_file_path</span>(cls, path: str, workspace: Path) -> tuple[bool, str]:
        <span class="string">"""Ensure path doesn't escape workspace."""</span>
        <span class="keyword">try</span>:
            resolved = (workspace / path).resolve()
            <span class="keyword">if not</span> str(resolved).startswith(str(workspace.resolve())):
                <span class="keyword">return</span> <span class="keyword">False</span>, <span class="string">"Path escapes workspace directory"</span>
            <span class="keyword">return</span> <span class="keyword">True</span>, <span class="string">""</span>
        <span class="keyword">except</span>:
            <span class="keyword">return</span> <span class="keyword">False</span>, <span class="string">"Invalid path"</span>

    <span class="decorator">@classmethod</span>
    <span class="keyword">def</span> <span class="function">check_secrets_exposure</span>(cls, content: str) -> tuple[bool, list]:
        <span class="string">"""Detect potential secrets in content."""</span>
        secrets_found = []
        patterns = {
            <span class="string">"AWS Key"</span>: r<span class="string">"AKIA[0-9A-Z]{16}"</span>,
            <span class="string">"API Key"</span>: r<span class="string">"api[_-]?key['\"]?\s*[:=]\s*['\"][a-zA-Z0-9]{20,}"</span>,
            <span class="string">"Private Key"</span>: r<span class="string">"-----BEGIN\s+(RSA\s+)?PRIVATE\s+KEY-----"</span>,
            <span class="string">"Password"</span>: r<span class="string">"password['\"]?\s*[:=]\s*['\"][^'\"]{8,}"</span>,
        }

        <span class="keyword">for</span> name, pattern <span class="keyword">in</span> patterns.items():
            <span class="keyword">if</span> re.search(pattern, content, re.IGNORECASE):
                secrets_found.append(name)

        <span class="keyword">return</span> len(secrets_found) == <span class="number">0</span>, secrets_found</pre>
                </div>
            </div>
        </section>

        <!-- Sources -->
        <div class="source-links">
            <h4>üìö Official Documentation & Resources</h4>
            <a href="https://github.com/NVIDIA/NeMo-Guardrails" target="_blank">‚Üí NeMo Guardrails GitHub Repository</a>
            <a href="https://developer.nvidia.com/nemo-guardrails" target="_blank">‚Üí NVIDIA NeMo Guardrails Developer Page</a>
            <a href="https://www.guardrailsai.com/" target="_blank">‚Üí Guardrails AI Official Website</a>
            <a href="https://docs.langchain.com/oss/python/langchain/guardrails" target="_blank">‚Üí LangChain Guardrails Documentation</a>
            <a href="https://pypi.org/project/nemoguardrails/" target="_blank">‚Üí NeMo Guardrails PyPI Package</a>
            <a href="https://www.guardrailsai.com/blog/nemoguardrails-integration" target="_blank">‚Üí Guardrails AI + NeMo Integration Guide</a>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>AI Security & Guardrails Implementation Guide</p>
            <p style="margin-top: 10px;"><a href="flows/index.html">‚Üê Back to Architecture Docs</a></p>
        </footer>
    </div>
</body>
</html>
