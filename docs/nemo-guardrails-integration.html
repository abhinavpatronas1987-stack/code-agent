<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeMo Guardrails Integration Guide - Code Agent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        h1 {
            text-align: center;
            font-size: 2.8em;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00d4ff, #7c3aed, #f472b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 40px rgba(124, 58, 237, 0.3);
        }

        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 40px;
            font-size: 1.2em;
        }

        /* Answer Box */
        .answer-box {
            background: linear-gradient(135deg, #1e4620 0%, #0d2818 100%);
            border: 2px solid #22c55e;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 40px;
            text-align: center;
        }

        .answer-box h2 {
            color: #22c55e;
            font-size: 2em;
            margin-bottom: 15px;
        }

        .answer-box p {
            font-size: 1.2em;
            color: #86efac;
        }

        /* Architecture Section */
        .architecture-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .architecture-section h2 {
            color: #00d4ff;
            margin-bottom: 20px;
            font-size: 1.6em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Integration Diagram */
        .integration-diagram {
            background: #0d1117;
            border-radius: 12px;
            padding: 30px;
            margin: 20px 0;
            overflow-x: auto;
        }

        .diagram-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .diagram-box {
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            min-width: 150px;
        }

        .box-user { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .box-guardrail { background: linear-gradient(135deg, #ef4444, #b91c1c); }
        .box-agent { background: linear-gradient(135deg, #8b5cf6, #6d28d9); }
        .box-llm { background: linear-gradient(135deg, #10b981, #047857); }
        .box-tools { background: linear-gradient(135deg, #f59e0b, #d97706); }

        .arrow {
            color: #666;
            font-size: 1.5em;
        }

        /* File Structure */
        .file-structure {
            background: #0d1117;
            border-radius: 12px;
            padding: 20px;
            font-family: 'Consolas', monospace;
            margin: 20px 0;
        }

        .file-structure .folder {
            color: #f59e0b;
        }

        .file-structure .file {
            color: #60a5fa;
        }

        .file-structure .new-file {
            color: #22c55e;
        }

        /* Code Blocks */
        .code-section {
            margin: 20px 0;
        }

        .code-section h3 {
            color: #f472b6;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-path {
            background: #1e1e1e;
            color: #888;
            padding: 10px 20px;
            border-radius: 8px 8px 0 0;
            font-family: 'Consolas', monospace;
            font-size: 0.9em;
            border-bottom: 1px solid #333;
        }

        pre {
            background: #0d1117;
            border-radius: 0 0 12px 12px;
            padding: 20px;
            overflow-x: auto;
            margin: 0;
        }

        code {
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .comment { color: #6a737d; }
        .keyword { color: #ff79c6; }
        .string { color: #a5d6ff; }
        .function { color: #d2a8ff; }
        .class-name { color: #79c0ff; }
        .decorator { color: #f0883e; }
        .number { color: #79c0ff; }
        .builtin { color: #ffa657; }

        /* Steps */
        .step {
            background: rgba(255, 255, 255, 0.03);
            border-left: 4px solid #7c3aed;
            padding: 25px;
            margin: 20px 0;
            border-radius: 0 12px 12px 0;
        }

        .step-number {
            display: inline-block;
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            border-radius: 50%;
            text-align: center;
            line-height: 36px;
            font-weight: bold;
            margin-right: 15px;
        }

        .step h3 {
            color: #a855f7;
            display: inline;
        }

        /* Config Files */
        .config-block {
            background: #1a1a2e;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            border: 1px solid #333;
        }

        .config-block h4 {
            color: #00d4ff;
            margin-bottom: 10px;
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #333;
        }

        th {
            background: #1a1a2e;
            color: #00d4ff;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        /* Warning/Info Boxes */
        .info-box {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3b82f6;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .warning-box {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid #f59e0b;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .success-box {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid #22c55e;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        /* Interview Tips */
        .interview-tip {
            background: linear-gradient(135deg, #312e81 0%, #1e1b4b 100%);
            border: 1px solid #6366f1;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .interview-tip h4 {
            color: #818cf8;
            margin-bottom: 10px;
        }

        /* Navigation */
        .nav-links {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 30px;
            justify-content: center;
        }

        .nav-links a {
            color: #00d4ff;
            text-decoration: none;
            padding: 10px 20px;
            background: rgba(0, 212, 255, 0.1);
            border-radius: 8px;
            transition: all 0.3s;
        }

        .nav-links a:hover {
            background: rgba(0, 212, 255, 0.2);
            transform: translateY(-2px);
        }

        /* Responsive */
        @media (max-width: 768px) {
            h1 { font-size: 2em; }
            .diagram-row { flex-direction: column; }
            .arrow { transform: rotate(90deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>NeMo Guardrails Integration</h1>
        <p class="subtitle">Complete Implementation Guide for Code Agent</p>

        <div class="nav-links">
            <a href="architecture-diagram.html">Architecture</a>
            <a href="ai-design-patterns.html">AI Patterns</a>
            <a href="security-guardrails-guide.html">Security Guide</a>
            <a href="interview-50-questions.html">Interview Q&A</a>
        </div>

        <!-- Answer Box -->
        <div class="answer-box">
            <h2>YES - NeMo Guardrails Can Be Integrated!</h2>
            <p>Your Agno-based architecture has clear integration points. NeMo Guardrails wraps around your existing LLM calls without modifying Agno internals.</p>
        </div>

        <!-- Architecture Overview -->
        <div class="architecture-section">
            <h2>Current vs. Guardrailed Architecture</h2>

            <h3 style="color: #888; margin: 20px 0 10px;">Current Flow (Without Guardrails)</h3>
            <div class="integration-diagram">
                <div class="diagram-row">
                    <div class="diagram-box box-user">User Input</div>
                    <span class="arrow">--></span>
                    <div class="diagram-box box-agent">CodingAgent</div>
                    <span class="arrow">--></span>
                    <div class="diagram-box box-llm">Agno Agent</div>
                    <span class="arrow">--></span>
                    <div class="diagram-box box-llm">Claude/Ollama</div>
                </div>
            </div>

            <h3 style="color: #22c55e; margin: 20px 0 10px;">New Flow (With NeMo Guardrails)</h3>
            <div class="integration-diagram">
                <div class="diagram-row">
                    <div class="diagram-box box-user">User Input</div>
                    <span class="arrow">--></span>
                    <div class="diagram-box box-guardrail">Input Rails</div>
                    <span class="arrow">--></span>
                    <div class="diagram-box box-agent">CodingAgent</div>
                    <span class="arrow">--></span>
                    <div class="diagram-box box-llm">Agno Agent</div>
                    <span class="arrow">--></span>
                    <div class="diagram-box box-guardrail">Output Rails</div>
                    <span class="arrow">--></span>
                    <div class="diagram-box box-user">Response</div>
                </div>
            </div>
        </div>

        <!-- File Structure -->
        <div class="architecture-section">
            <h2>Files to Create/Modify</h2>

            <div class="file-structure">
<pre>
code-agent/
├── src/
│   ├── <span class="folder">guardrails/</span>              <span class="new-file"># NEW FOLDER</span>
│   │   ├── <span class="new-file">__init__.py</span>
│   │   ├── <span class="new-file">config.py</span>           # Guardrails configuration
│   │   ├── <span class="new-file">rails.py</span>            # Rail definitions
│   │   ├── <span class="new-file">actions.py</span>          # Custom actions
│   │   └── <span class="new-file">wrapper.py</span>          # Agent wrapper
│   │
│   ├── agents/
│   │   └── <span class="file">coding_agent.py</span>     # MODIFY: Add guardrails
│   │
│   └── core/
│       └── <span class="file">llm.py</span>              # MODIFY: Wrap with guardrails
│
├── <span class="folder">guardrails_config/</span>          <span class="new-file"># NEW FOLDER - NeMo config files</span>
│   ├── <span class="new-file">config.yml</span>
│   ├── <span class="new-file">prompts.yml</span>
│   └── <span class="new-file">rails.co</span>
│
└── requirements.txt            # ADD: nemoguardrails
</pre>
            </div>
        </div>

        <!-- Step 1: Installation -->
        <div class="step">
            <span class="step-number">1</span>
            <h3>Install NeMo Guardrails</h3>

            <div class="code-section">
                <div class="file-path">Terminal</div>
                <pre><code><span class="comment"># Install NeMo Guardrails</span>
pip install nemoguardrails

<span class="comment"># Or add to requirements.txt</span>
<span class="keyword">echo</span> <span class="string">"nemoguardrails>=0.10.0"</span> >> requirements.txt
pip install -r requirements.txt</code></pre>
            </div>
        </div>

        <!-- Step 2: Create Config Files -->
        <div class="step">
            <span class="step-number">2</span>
            <h3>Create NeMo Configuration Files</h3>

            <div class="code-section">
                <div class="file-path">guardrails_config/config.yml</div>
                <pre><code><span class="comment"># NeMo Guardrails Configuration for Code Agent</span>

<span class="keyword">models</span>:
  - <span class="keyword">type</span>: main
    <span class="keyword">engine</span>: openai  <span class="comment"># or anthropic</span>
    <span class="keyword">model</span>: gpt-4   <span class="comment"># Your configured model</span>

<span class="keyword">rails</span>:
  <span class="keyword">input</span>:
    <span class="keyword">flows</span>:
      - check jailbreak
      - check input safety
      - check code injection
      - check file path safety

  <span class="keyword">output</span>:
    <span class="keyword">flows</span>:
      - check output safety
      - check sensitive data
      - check code safety

<span class="keyword">instructions</span>:
  - <span class="keyword">type</span>: general
    <span class="keyword">content</span>: |
      You are Code Agent, an AI coding assistant.
      You help with software development tasks safely.
      Never execute destructive commands without confirmation.
      Never expose sensitive information like API keys or passwords.

<span class="keyword">sample_conversation</span>: |
  user "Help me write a Python function"
  bot "I'd be happy to help you write a Python function. What should it do?"</code></pre>
            </div>

            <div class="code-section">
                <div class="file-path">guardrails_config/rails.co</div>
                <pre><code><span class="comment"># Colang 2.0 Rail Definitions</span>

<span class="comment"># ============ INPUT RAILS ============</span>

<span class="keyword">define</span> <span class="function">flow</span> check jailbreak
  <span class="keyword">$is_jailbreak</span> = <span class="builtin">execute</span> check_jailbreak_attempt(user_input=$user_message)

  <span class="keyword">if</span> $is_jailbreak
    bot refuse jailbreak
    <span class="keyword">stop</span>

<span class="keyword">define</span> <span class="function">flow</span> check code injection
  <span class="keyword">$has_injection</span> = <span class="builtin">execute</span> check_code_injection(user_input=$user_message)

  <span class="keyword">if</span> $has_injection
    bot warn code injection
    <span class="keyword">stop</span>

<span class="keyword">define</span> <span class="function">flow</span> check file path safety
  <span class="keyword">$unsafe_path</span> = <span class="builtin">execute</span> check_unsafe_file_path(user_input=$user_message)

  <span class="keyword">if</span> $unsafe_path
    bot refuse unsafe path
    <span class="keyword">stop</span>

<span class="keyword">define</span> <span class="function">flow</span> check input safety
  <span class="keyword">$is_unsafe</span> = <span class="builtin">execute</span> check_input_safety(user_input=$user_message)

  <span class="keyword">if</span> $is_unsafe
    bot refuse unsafe input
    <span class="keyword">stop</span>

<span class="comment"># ============ OUTPUT RAILS ============</span>

<span class="keyword">define</span> <span class="function">flow</span> check output safety
  <span class="keyword">$has_unsafe_content</span> = <span class="builtin">execute</span> check_output_safety(bot_response=$bot_message)

  <span class="keyword">if</span> $has_unsafe_content
    $bot_message = <span class="builtin">execute</span> sanitize_output(text=$bot_message)

<span class="keyword">define</span> <span class="function">flow</span> check sensitive data
  <span class="keyword">$has_secrets</span> = <span class="builtin">execute</span> detect_secrets(text=$bot_message)

  <span class="keyword">if</span> $has_secrets
    $bot_message = <span class="builtin">execute</span> redact_secrets(text=$bot_message)

<span class="keyword">define</span> <span class="function">flow</span> check code safety
  <span class="keyword">$has_dangerous_code</span> = <span class="builtin">execute</span> check_dangerous_code(code=$bot_message)

  <span class="keyword">if</span> $has_dangerous_code
    bot warn dangerous code

<span class="comment"># ============ BOT RESPONSES ============</span>

<span class="keyword">define</span> <span class="function">bot</span> refuse jailbreak
  <span class="string">"I cannot help with that request. I'm designed to assist with legitimate coding tasks only."</span>

<span class="keyword">define</span> <span class="function">bot</span> warn code injection
  <span class="string">"I detected a potential code injection attempt. Please rephrase your request safely."</span>

<span class="keyword">define</span> <span class="function">bot</span> refuse unsafe path
  <span class="string">"I cannot access system directories or sensitive paths. Please specify a safe working directory."</span>

<span class="keyword">define</span> <span class="function">bot</span> refuse unsafe input
  <span class="string">"I cannot process this request as it may be unsafe. Please rephrase."</span>

<span class="keyword">define</span> <span class="function">bot</span> warn dangerous code
  <span class="string">"Warning: The generated code contains potentially dangerous operations. Please review carefully before executing."</span></code></pre>
            </div>
        </div>

        <!-- Step 3: Create Guardrails Module -->
        <div class="step">
            <span class="step-number">3</span>
            <h3>Create Guardrails Module</h3>

            <div class="code-section">
                <div class="file-path">src/guardrails/__init__.py</div>
                <pre><code><span class="string">"""Guardrails module for Code Agent security."""</span>

<span class="keyword">from</span> .wrapper <span class="keyword">import</span> GuardrailsWrapper, get_guardrails
<span class="keyword">from</span> .config <span class="keyword">import</span> GuardrailsConfig
<span class="keyword">from</span> .rails <span class="keyword">import</span> InputRail, OutputRail

<span class="builtin">__all__</span> = [
    <span class="string">"GuardrailsWrapper"</span>,
    <span class="string">"get_guardrails"</span>,
    <span class="string">"GuardrailsConfig"</span>,
    <span class="string">"InputRail"</span>,
    <span class="string">"OutputRail"</span>,
]</code></pre>
            </div>

            <div class="code-section">
                <div class="file-path">src/guardrails/config.py</div>
                <pre><code><span class="string">"""Guardrails configuration."""</span>

<span class="keyword">from</span> pathlib <span class="keyword">import</span> Path
<span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass, field
<span class="keyword">from</span> typing <span class="keyword">import</span> List, Optional


<span class="decorator">@dataclass</span>
<span class="keyword">class</span> <span class="class-name">GuardrailsConfig</span>:
    <span class="string">"""Configuration for NeMo Guardrails integration."""</span>

    <span class="comment"># Enable/disable guardrails</span>
    enabled: <span class="builtin">bool</span> = <span class="keyword">True</span>

    <span class="comment"># Path to NeMo config directory</span>
    config_path: Path = field(default_factory=<span class="keyword">lambda</span>: Path(<span class="string">"guardrails_config"</span>))

    <span class="comment"># Input rails to enable</span>
    input_rails: List[<span class="builtin">str</span>] = field(default_factory=<span class="keyword">lambda</span>: [
        <span class="string">"check_jailbreak"</span>,
        <span class="string">"check_code_injection"</span>,
        <span class="string">"check_file_path_safety"</span>,
        <span class="string">"check_input_safety"</span>,
    ])

    <span class="comment"># Output rails to enable</span>
    output_rails: List[<span class="builtin">str</span>] = field(default_factory=<span class="keyword">lambda</span>: [
        <span class="string">"check_output_safety"</span>,
        <span class="string">"check_sensitive_data"</span>,
        <span class="string">"check_code_safety"</span>,
    ])

    <span class="comment"># Blocked commands (terminal safety)</span>
    blocked_commands: List[<span class="builtin">str</span>] = field(default_factory=<span class="keyword">lambda</span>: [
        <span class="string">"rm -rf /"</span>,
        <span class="string">"format c:"</span>,
        <span class="string">"del /f /s /q"</span>,
        <span class="string">":(){:|:&};:"</span>,  <span class="comment"># Fork bomb</span>
        <span class="string">"dd if=/dev/zero"</span>,
        <span class="string">"mkfs"</span>,
        <span class="string">"> /dev/sda"</span>,
    ])

    <span class="comment"># Blocked file paths</span>
    blocked_paths: List[<span class="builtin">str</span>] = field(default_factory=<span class="keyword">lambda</span>: [
        <span class="string">"/etc/passwd"</span>,
        <span class="string">"/etc/shadow"</span>,
        <span class="string">"C:\\Windows\\System32"</span>,
        <span class="string">"~/.ssh"</span>,
        <span class="string">"~/.aws"</span>,
        <span class="string">".env"</span>,
    ])

    <span class="comment"># Patterns to redact from output</span>
    secret_patterns: List[<span class="builtin">str</span>] = field(default_factory=<span class="keyword">lambda</span>: [
        <span class="string">r"(?i)(api[_-]?key|apikey)['\"]?\s*[:=]\s*['\"]?[\w\-]+"</span>,
        <span class="string">r"(?i)(password|passwd|pwd)['\"]?\s*[:=]\s*['\"]?[^\s,}]+"</span>,
        <span class="string">r"(?i)(secret|token)['\"]?\s*[:=]\s*['\"]?[\w\-]+"</span>,
        <span class="string">r"(?i)bearer\s+[\w\-\.]+"</span>,
        <span class="string">r"sk-[a-zA-Z0-9]{48}"</span>,  <span class="comment"># OpenAI keys</span>
        <span class="string">r"ghp_[a-zA-Z0-9]{36}"</span>,  <span class="comment"># GitHub tokens</span>
    ])

    <span class="comment"># Maximum input length</span>
    max_input_length: <span class="builtin">int</span> = <span class="number">50000</span>

    <span class="comment"># Logging</span>
    log_blocked_requests: <span class="builtin">bool</span> = <span class="keyword">True</span>
    log_file: Optional[Path] = <span class="keyword">None</span>


<span class="keyword">def</span> <span class="function">get_default_config</span>() -> GuardrailsConfig:
    <span class="string">"""Get default guardrails configuration."""</span>
    <span class="keyword">return</span> GuardrailsConfig()</code></pre>
            </div>

            <div class="code-section">
                <div class="file-path">src/guardrails/actions.py</div>
                <pre><code><span class="string">"""Custom NeMo Guardrails actions for Code Agent."""</span>

<span class="keyword">import</span> re
<span class="keyword">from</span> typing <span class="keyword">import</span> Optional
<span class="keyword">from</span> nemoguardrails.actions <span class="keyword">import</span> action

<span class="keyword">from</span> .config <span class="keyword">import</span> GuardrailsConfig


<span class="comment"># Global config instance</span>
_config: Optional[GuardrailsConfig] = <span class="keyword">None</span>


<span class="keyword">def</span> <span class="function">set_config</span>(config: GuardrailsConfig):
    <span class="string">"""Set the guardrails configuration."""</span>
    <span class="keyword">global</span> _config
    _config = config


<span class="keyword">def</span> <span class="function">get_config</span>() -> GuardrailsConfig:
    <span class="string">"""Get current configuration."""</span>
    <span class="keyword">global</span> _config
    <span class="keyword">if</span> _config <span class="keyword">is</span> <span class="keyword">None</span>:
        _config = GuardrailsConfig()
    <span class="keyword">return</span> _config


<span class="comment"># ============ INPUT RAIL ACTIONS ============</span>

<span class="decorator">@action</span>(name=<span class="string">"check_jailbreak_attempt"</span>)
<span class="keyword">async def</span> <span class="function">check_jailbreak_attempt</span>(user_input: <span class="builtin">str</span>) -> <span class="builtin">bool</span>:
    <span class="string">"""Check if input contains jailbreak attempts."""</span>
    jailbreak_patterns = [
        <span class="string">r"ignore (all )?(previous |prior )?instructions"</span>,
        <span class="string">r"disregard (all )?(previous |prior )?instructions"</span>,
        <span class="string">r"forget (all )?(previous |prior )?instructions"</span>,
        <span class="string">r"you are now (a |an )?(?!coding|code|software|developer)"</span>,
        <span class="string">r"pretend (you are|to be) (a |an )?(?!coding|developer)"</span>,
        <span class="string">r"act as (a |an )?(?!coding|developer)"</span>,
        <span class="string">r"DAN mode"</span>,
        <span class="string">r"developer mode"</span>,
        <span class="string">r"jailbreak"</span>,
    ]

    text_lower = user_input.lower()
    <span class="keyword">for</span> pattern <span class="keyword">in</span> jailbreak_patterns:
        <span class="keyword">if</span> re.search(pattern, text_lower):
            <span class="keyword">return</span> <span class="keyword">True</span>

    <span class="keyword">return</span> <span class="keyword">False</span>


<span class="decorator">@action</span>(name=<span class="string">"check_code_injection"</span>)
<span class="keyword">async def</span> <span class="function">check_code_injection</span>(user_input: <span class="builtin">str</span>) -> <span class="builtin">bool</span>:
    <span class="string">"""Check for code injection attempts."""</span>
    config = get_config()

    <span class="comment"># Check for blocked commands</span>
    text_lower = user_input.lower()
    <span class="keyword">for</span> cmd <span class="keyword">in</span> config.blocked_commands:
        <span class="keyword">if</span> cmd.lower() <span class="keyword">in</span> text_lower:
            <span class="keyword">return</span> <span class="keyword">True</span>

    <span class="comment"># Check for shell injection patterns</span>
    injection_patterns = [
        <span class="string">r";\s*(rm|del|format|dd|mkfs)"</span>,
        <span class="string">r"\|\s*(rm|del|format)"</span>,
        <span class="string">r"`[^`]*`"</span>,  <span class="comment"># Backtick command substitution</span>
        <span class="string">r"\$\([^)]+\)"</span>,  <span class="comment"># $() command substitution</span>
    ]

    <span class="keyword">for</span> pattern <span class="keyword">in</span> injection_patterns:
        <span class="keyword">if</span> re.search(pattern, text_lower):
            <span class="keyword">return</span> <span class="keyword">True</span>

    <span class="keyword">return</span> <span class="keyword">False</span>


<span class="decorator">@action</span>(name=<span class="string">"check_unsafe_file_path"</span>)
<span class="keyword">async def</span> <span class="function">check_unsafe_file_path</span>(user_input: <span class="builtin">str</span>) -> <span class="builtin">bool</span>:
    <span class="string">"""Check for attempts to access unsafe file paths."""</span>
    config = get_config()

    <span class="keyword">for</span> blocked_path <span class="keyword">in</span> config.blocked_paths:
        <span class="keyword">if</span> blocked_path.lower() <span class="keyword">in</span> user_input.lower():
            <span class="keyword">return</span> <span class="keyword">True</span>

    <span class="comment"># Check for path traversal</span>
    <span class="keyword">if</span> re.search(<span class="string">r"\.\.[/\\]"</span>, user_input):
        <span class="keyword">return</span> <span class="keyword">True</span>

    <span class="keyword">return</span> <span class="keyword">False</span>


<span class="decorator">@action</span>(name=<span class="string">"check_input_safety"</span>)
<span class="keyword">async def</span> <span class="function">check_input_safety</span>(user_input: <span class="builtin">str</span>) -> <span class="builtin">bool</span>:
    <span class="string">"""General input safety check."""</span>
    config = get_config()

    <span class="comment"># Check length</span>
    <span class="keyword">if</span> <span class="builtin">len</span>(user_input) > config.max_input_length:
        <span class="keyword">return</span> <span class="keyword">True</span>

    <span class="keyword">return</span> <span class="keyword">False</span>


<span class="comment"># ============ OUTPUT RAIL ACTIONS ============</span>

<span class="decorator">@action</span>(name=<span class="string">"check_output_safety"</span>)
<span class="keyword">async def</span> <span class="function">check_output_safety</span>(bot_response: <span class="builtin">str</span>) -> <span class="builtin">bool</span>:
    <span class="string">"""Check if output contains unsafe content."""</span>
    config = get_config()

    <span class="comment"># Check for blocked commands in output</span>
    response_lower = bot_response.lower()
    <span class="keyword">for</span> cmd <span class="keyword">in</span> config.blocked_commands:
        <span class="keyword">if</span> cmd.lower() <span class="keyword">in</span> response_lower:
            <span class="keyword">return</span> <span class="keyword">True</span>

    <span class="keyword">return</span> <span class="keyword">False</span>


<span class="decorator">@action</span>(name=<span class="string">"detect_secrets"</span>)
<span class="keyword">async def</span> <span class="function">detect_secrets</span>(text: <span class="builtin">str</span>) -> <span class="builtin">bool</span>:
    <span class="string">"""Detect if text contains secrets or sensitive data."""</span>
    config = get_config()

    <span class="keyword">for</span> pattern <span class="keyword">in</span> config.secret_patterns:
        <span class="keyword">if</span> re.search(pattern, text):
            <span class="keyword">return</span> <span class="keyword">True</span>

    <span class="keyword">return</span> <span class="keyword">False</span>


<span class="decorator">@action</span>(name=<span class="string">"redact_secrets"</span>)
<span class="keyword">async def</span> <span class="function">redact_secrets</span>(text: <span class="builtin">str</span>) -> <span class="builtin">str</span>:
    <span class="string">"""Redact secrets from text."""</span>
    config = get_config()
    result = text

    <span class="keyword">for</span> pattern <span class="keyword">in</span> config.secret_patterns:
        result = re.sub(pattern, <span class="string">"[REDACTED]"</span>, result, flags=re.IGNORECASE)

    <span class="keyword">return</span> result


<span class="decorator">@action</span>(name=<span class="string">"sanitize_output"</span>)
<span class="keyword">async def</span> <span class="function">sanitize_output</span>(text: <span class="builtin">str</span>) -> <span class="builtin">str</span>:
    <span class="string">"""Sanitize output by removing unsafe content."""</span>
    config = get_config()
    result = text

    <span class="comment"># Remove blocked commands</span>
    <span class="keyword">for</span> cmd <span class="keyword">in</span> config.blocked_commands:
        result = result.replace(cmd, <span class="string">"[BLOCKED COMMAND]"</span>)

    <span class="keyword">return</span> result


<span class="decorator">@action</span>(name=<span class="string">"check_dangerous_code"</span>)
<span class="keyword">async def</span> <span class="function">check_dangerous_code</span>(code: <span class="builtin">str</span>) -> <span class="builtin">bool</span>:
    <span class="string">"""Check if generated code contains dangerous operations."""</span>
    dangerous_patterns = [
        <span class="string">r"subprocess\.call\([^)]*shell\s*=\s*True"</span>,
        <span class="string">r"os\.system\("</span>,
        <span class="string">r"eval\("</span>,
        <span class="string">r"exec\("</span>,
        <span class="string">r"__import__\("</span>,
        <span class="string">r"pickle\.loads\("</span>,
        <span class="string">r"yaml\.load\([^)]*Loader\s*=\s*yaml\.Loader"</span>,  <span class="comment"># Unsafe YAML</span>
    ]

    <span class="keyword">for</span> pattern <span class="keyword">in</span> dangerous_patterns:
        <span class="keyword">if</span> re.search(pattern, code):
            <span class="keyword">return</span> <span class="keyword">True</span>

    <span class="keyword">return</span> <span class="keyword">False</span></code></pre>
            </div>

            <div class="code-section">
                <div class="file-path">src/guardrails/wrapper.py</div>
                <pre><code><span class="string">"""Main guardrails wrapper for Code Agent."""</span>

<span class="keyword">import</span> logging
<span class="keyword">from</span> pathlib <span class="keyword">import</span> Path
<span class="keyword">from</span> typing <span class="keyword">import</span> Any, Optional, Generator

<span class="keyword">try</span>:
    <span class="keyword">from</span> nemoguardrails <span class="keyword">import</span> RailsConfig, LLMRails
    <span class="keyword">from</span> nemoguardrails.actions.actions <span class="keyword">import</span> ActionResult
    NEMO_AVAILABLE = <span class="keyword">True</span>
<span class="keyword">except</span> ImportError:
    NEMO_AVAILABLE = <span class="keyword">False</span>

<span class="keyword">from</span> .config <span class="keyword">import</span> GuardrailsConfig, get_default_config
<span class="keyword">from</span> . <span class="keyword">import</span> actions


logger = logging.getLogger(__name__)


<span class="keyword">class</span> <span class="class-name">GuardrailsWrapper</span>:
    <span class="string">"""
    Wrapper that adds NeMo Guardrails to the Code Agent.

    This wrapper intercepts input/output and applies safety rails
    without modifying the core Agno agent.
    """</span>

    <span class="keyword">def</span> <span class="function">__init__</span>(
        <span class="builtin">self</span>,
        config: Optional[GuardrailsConfig] = <span class="keyword">None</span>,
        config_path: Optional[Path] = <span class="keyword">None</span>,
    ):
        <span class="string">"""
        Initialize the guardrails wrapper.

        Args:
            config: Guardrails configuration
            config_path: Path to NeMo config directory
        """</span>
        <span class="builtin">self</span>.config = config <span class="keyword">or</span> get_default_config()
        <span class="builtin">self</span>.rails: Optional[LLMRails] = <span class="keyword">None</span>
        <span class="builtin">self</span>._initialized = <span class="keyword">False</span>

        <span class="comment"># Set config for actions module</span>
        actions.set_config(<span class="builtin">self</span>.config)

        <span class="comment"># Initialize NeMo if available and enabled</span>
        <span class="keyword">if</span> <span class="builtin">self</span>.config.enabled <span class="keyword">and</span> NEMO_AVAILABLE:
            <span class="builtin">self</span>._init_nemo(config_path <span class="keyword">or</span> <span class="builtin">self</span>.config.config_path)

    <span class="keyword">def</span> <span class="function">_init_nemo</span>(<span class="builtin">self</span>, config_path: Path):
        <span class="string">"""Initialize NeMo Guardrails."""</span>
        <span class="keyword">try</span>:
            <span class="keyword">if</span> config_path.exists():
                rails_config = RailsConfig.from_path(<span class="builtin">str</span>(config_path))
                <span class="builtin">self</span>.rails = LLMRails(rails_config)

                <span class="comment"># Register custom actions</span>
                <span class="builtin">self</span>.rails.register_action(actions.check_jailbreak_attempt)
                <span class="builtin">self</span>.rails.register_action(actions.check_code_injection)
                <span class="builtin">self</span>.rails.register_action(actions.check_unsafe_file_path)
                <span class="builtin">self</span>.rails.register_action(actions.check_input_safety)
                <span class="builtin">self</span>.rails.register_action(actions.check_output_safety)
                <span class="builtin">self</span>.rails.register_action(actions.detect_secrets)
                <span class="builtin">self</span>.rails.register_action(actions.redact_secrets)
                <span class="builtin">self</span>.rails.register_action(actions.sanitize_output)
                <span class="builtin">self</span>.rails.register_action(actions.check_dangerous_code)

                <span class="builtin">self</span>._initialized = <span class="keyword">True</span>
                logger.info(<span class="string">"NeMo Guardrails initialized successfully"</span>)
            <span class="keyword">else</span>:
                logger.warning(<span class="string">f"Guardrails config not found at {config_path}"</span>)
        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:
            logger.error(<span class="string">f"Failed to initialize NeMo Guardrails: {e}"</span>)

    <span class="keyword">async def</span> <span class="function">check_input</span>(<span class="builtin">self</span>, user_input: <span class="builtin">str</span>) -> <span class="builtin">tuple</span>[<span class="builtin">bool</span>, Optional[<span class="builtin">str</span>]]:
        <span class="string">"""
        Check input through guardrails.

        Returns:
            Tuple of (is_safe, error_message)
        """</span>
        <span class="keyword">if</span> <span class="keyword">not</span> <span class="builtin">self</span>.config.enabled:
            <span class="keyword">return</span> <span class="keyword">True</span>, <span class="keyword">None</span>

        <span class="comment"># Use NeMo if available</span>
        <span class="keyword">if</span> <span class="builtin">self</span>._initialized <span class="keyword">and</span> <span class="builtin">self</span>.rails:
            <span class="keyword">try</span>:
                response = <span class="keyword">await</span> <span class="builtin">self</span>.rails.generate_async(
                    messages=[{<span class="string">"role"</span>: <span class="string">"user"</span>, <span class="string">"content"</span>: user_input}]
                )
                <span class="comment"># Check if blocked</span>
                <span class="keyword">if</span> response.get(<span class="string">"blocked"</span>):
                    <span class="keyword">return</span> <span class="keyword">False</span>, response.get(<span class="string">"message"</span>, <span class="string">"Input blocked by guardrails"</span>)
            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:
                logger.error(<span class="string">f"NeMo input check failed: {e}"</span>)

        <span class="comment"># Fallback to simple checks</span>
        <span class="keyword">if</span> <span class="keyword">await</span> actions.check_jailbreak_attempt(user_input):
            <span class="keyword">return</span> <span class="keyword">False</span>, <span class="string">"Jailbreak attempt detected"</span>

        <span class="keyword">if</span> <span class="keyword">await</span> actions.check_code_injection(user_input):
            <span class="keyword">return</span> <span class="keyword">False</span>, <span class="string">"Code injection detected"</span>

        <span class="keyword">if</span> <span class="keyword">await</span> actions.check_unsafe_file_path(user_input):
            <span class="keyword">return</span> <span class="keyword">False</span>, <span class="string">"Unsafe file path detected"</span>

        <span class="keyword">return</span> <span class="keyword">True</span>, <span class="keyword">None</span>

    <span class="keyword">async def</span> <span class="function">process_output</span>(<span class="builtin">self</span>, output: <span class="builtin">str</span>) -> <span class="builtin">str</span>:
        <span class="string">"""Process and sanitize output through guardrails."""</span>
        <span class="keyword">if</span> <span class="keyword">not</span> <span class="builtin">self</span>.config.enabled:
            <span class="keyword">return</span> output

        result = output

        <span class="comment"># Redact secrets</span>
        <span class="keyword">if</span> <span class="keyword">await</span> actions.detect_secrets(result):
            result = <span class="keyword">await</span> actions.redact_secrets(result)

        <span class="comment"># Sanitize unsafe content</span>
        <span class="keyword">if</span> <span class="keyword">await</span> actions.check_output_safety(result):
            result = <span class="keyword">await</span> actions.sanitize_output(result)

        <span class="keyword">return</span> result

    <span class="keyword">def</span> <span class="function">check_input_sync</span>(<span class="builtin">self</span>, user_input: <span class="builtin">str</span>) -> <span class="builtin">tuple</span>[<span class="builtin">bool</span>, Optional[<span class="builtin">str</span>]]:
        <span class="string">"""Synchronous version of check_input."""</span>
        <span class="keyword">import</span> asyncio

        <span class="keyword">try</span>:
            loop = asyncio.get_event_loop()
        <span class="keyword">except</span> RuntimeError:
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)

        <span class="keyword">return</span> loop.run_until_complete(<span class="builtin">self</span>.check_input(user_input))

    <span class="keyword">def</span> <span class="function">process_output_sync</span>(<span class="builtin">self</span>, output: <span class="builtin">str</span>) -> <span class="builtin">str</span>:
        <span class="string">"""Synchronous version of process_output."""</span>
        <span class="keyword">import</span> asyncio

        <span class="keyword">try</span>:
            loop = asyncio.get_event_loop()
        <span class="keyword">except</span> RuntimeError:
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)

        <span class="keyword">return</span> loop.run_until_complete(<span class="builtin">self</span>.process_output(output))


<span class="comment"># Singleton instance</span>
_guardrails: Optional[GuardrailsWrapper] = <span class="keyword">None</span>


<span class="keyword">def</span> <span class="function">get_guardrails</span>(config: Optional[GuardrailsConfig] = <span class="keyword">None</span>) -> GuardrailsWrapper:
    <span class="string">"""Get or create the guardrails wrapper singleton."""</span>
    <span class="keyword">global</span> _guardrails

    <span class="keyword">if</span> _guardrails <span class="keyword">is</span> <span class="keyword">None</span>:
        _guardrails = GuardrailsWrapper(config=config)

    <span class="keyword">return</span> _guardrails</code></pre>
            </div>
        </div>

        <!-- Step 4: Modify CodingAgent -->
        <div class="step">
            <span class="step-number">4</span>
            <h3>Integrate into CodingAgent</h3>

            <div class="code-section">
                <div class="file-path">src/agents/coding_agent.py (Modified)</div>
                <pre><code><span class="string">"""Main coding agent with NeMo Guardrails integration."""</span>

<span class="keyword">from</span> typing <span class="keyword">import</span> Any, Generator
<span class="keyword">from</span> pathlib <span class="keyword">import</span> Path

<span class="keyword">from</span> agno.agent <span class="keyword">import</span> Agent
<span class="keyword">from</span> agno.db.sqlite <span class="keyword">import</span> SqliteDb

<span class="keyword">from</span> src.config.settings <span class="keyword">import</span> get_settings
<span class="keyword">from</span> src.core.llm <span class="keyword">import</span> get_model
<span class="comment"># ... other imports ...</span>

<span class="comment"># NEW: Import guardrails</span>
<span class="keyword">try</span>:
    <span class="keyword">from</span> src.guardrails <span class="keyword">import</span> get_guardrails, GuardrailsConfig
    GUARDRAILS_AVAILABLE = <span class="keyword">True</span>
<span class="keyword">except</span> ImportError:
    GUARDRAILS_AVAILABLE = <span class="keyword">False</span>


<span class="keyword">class</span> <span class="class-name">CodingAgent</span>:
    <span class="string">"""Main coding agent with guardrails support."""</span>

    <span class="keyword">def</span> <span class="function">__init__</span>(
        <span class="builtin">self</span>,
        session_id: <span class="builtin">str</span> = <span class="string">"default"</span>,
        workspace: <span class="builtin">str</span> | Path | <span class="keyword">None</span> = <span class="keyword">None</span>,
        model_id: <span class="builtin">str</span> | <span class="keyword">None</span> = <span class="keyword">None</span>,
        <span class="comment"># NEW: Guardrails parameters</span>
        enable_guardrails: <span class="builtin">bool</span> = <span class="keyword">True</span>,
        guardrails_config: GuardrailsConfig | <span class="keyword">None</span> = <span class="keyword">None</span>,
    ):
        <span class="builtin">self</span>.settings = get_settings()
        <span class="builtin">self</span>.session_id = session_id

        <span class="comment"># ... existing initialization code ...</span>

        <span class="comment"># NEW: Initialize guardrails</span>
        <span class="builtin">self</span>.guardrails = <span class="keyword">None</span>
        <span class="keyword">if</span> enable_guardrails <span class="keyword">and</span> GUARDRAILS_AVAILABLE:
            <span class="builtin">self</span>.guardrails = get_guardrails(guardrails_config)

        <span class="comment"># ... rest of initialization ...</span>

    <span class="keyword">def</span> <span class="function">run</span>(<span class="builtin">self</span>, message: <span class="builtin">str</span>, stream: <span class="builtin">bool</span> = <span class="keyword">True</span>) -> Any:
        <span class="string">"""Run the agent with guardrails protection."""</span>

        <span class="comment"># NEW: Check input through guardrails</span>
        <span class="keyword">if</span> <span class="builtin">self</span>.guardrails:
            is_safe, error_msg = <span class="builtin">self</span>.guardrails.check_input_sync(message)
            <span class="keyword">if</span> <span class="keyword">not</span> is_safe:
                <span class="comment"># Return blocked response</span>
                <span class="keyword">return</span> <span class="builtin">self</span>._create_blocked_response(error_msg)

        <span class="comment"># Run the agent</span>
        response = <span class="builtin">self</span>.agent.run(message, stream=stream)

        <span class="comment"># NEW: Process output through guardrails (for non-streaming)</span>
        <span class="keyword">if</span> <span class="keyword">not</span> stream <span class="keyword">and</span> <span class="builtin">self</span>.guardrails:
            <span class="keyword">if</span> <span class="builtin">hasattr</span>(response, <span class="string">'content'</span>):
                response.content = <span class="builtin">self</span>.guardrails.process_output_sync(response.content)

        <span class="keyword">return</span> response

    <span class="keyword">def</span> <span class="function">run_with_guardrails</span>(<span class="builtin">self</span>, message: <span class="builtin">str</span>, stream: <span class="builtin">bool</span> = <span class="keyword">True</span>) -> Generator:
        <span class="string">"""Run with streaming and guardrails processing."""</span>

        <span class="comment"># Check input</span>
        <span class="keyword">if</span> <span class="builtin">self</span>.guardrails:
            is_safe, error_msg = <span class="builtin">self</span>.guardrails.check_input_sync(message)
            <span class="keyword">if</span> <span class="keyword">not</span> is_safe:
                <span class="keyword">yield</span> <span class="builtin">self</span>._create_blocked_response(error_msg)
                <span class="keyword">return</span>

        <span class="comment"># Stream response</span>
        full_response = <span class="string">""</span>
        <span class="keyword">for</span> chunk <span class="keyword">in</span> <span class="builtin">self</span>.agent.run(message, stream=<span class="keyword">True</span>):
            <span class="keyword">if</span> <span class="builtin">hasattr</span>(chunk, <span class="string">'content'</span>) <span class="keyword">and</span> chunk.content:
                full_response += chunk.content
            <span class="keyword">yield</span> chunk

        <span class="comment"># Post-process complete response</span>
        <span class="keyword">if</span> <span class="builtin">self</span>.guardrails <span class="keyword">and</span> full_response:
            <span class="comment"># Log any detected issues (don't modify streaming output)</span>
            processed = <span class="builtin">self</span>.guardrails.process_output_sync(full_response)
            <span class="keyword">if</span> processed != full_response:
                <span class="comment"># Log that content was sanitized</span>
                <span class="keyword">import</span> logging
                logging.warning(<span class="string">"Response was sanitized by guardrails"</span>)

    <span class="keyword">def</span> <span class="function">_create_blocked_response</span>(<span class="builtin">self</span>, error_msg: <span class="builtin">str</span>):
        <span class="string">"""Create a response for blocked input."""</span>
        <span class="keyword">class</span> <span class="class-name">BlockedResponse</span>:
            content = <span class="string">f"Request blocked: {error_msg}"</span>
            blocked = <span class="keyword">True</span>
        <span class="keyword">return</span> BlockedResponse()</code></pre>
            </div>
        </div>

        <!-- Step 5: CLI Integration -->
        <div class="step">
            <span class="step-number">5</span>
            <h3>CLI Integration (Optional)</h3>

            <div class="code-section">
                <div class="file-path">src/cli.py (Add to run_cli function)</div>
                <pre><code><span class="comment"># Add at the top of the file</span>
<span class="keyword">from</span> src.guardrails <span class="keyword">import</span> get_guardrails

<span class="comment"># In run_cli(), before processing user input:</span>
<span class="keyword">def</span> <span class="function">run_cli</span>():
    <span class="comment"># ... existing code ...</span>

    <span class="comment"># Initialize guardrails</span>
    guardrails = get_guardrails()

    <span class="keyword">while</span> <span class="keyword">True</span>:
        <span class="comment"># ... get user input ...</span>

        <span class="comment"># NEW: Pre-check input before sending to agent</span>
        <span class="keyword">if</span> <span class="keyword">not</span> user_input.startswith(<span class="string">"/"</span>):  <span class="comment"># Skip commands</span>
            is_safe, error_msg = guardrails.check_input_sync(user_input)
            <span class="keyword">if</span> <span class="keyword">not</span> is_safe:
                console.print(<span class="string">f"[red]Blocked: {error_msg}[/red]"</span>)
                <span class="keyword">continue</span>

        <span class="comment"># ... rest of processing ...</span></code></pre>
            </div>
        </div>

        <!-- Alternative: Lightweight Implementation -->
        <div class="architecture-section">
            <h2>Alternative: Lightweight Guardrails (No NeMo)</h2>
            <p>If you don't want the full NeMo dependency, here's a lightweight version:</p>

            <div class="code-section">
                <div class="file-path">src/guardrails/simple_rails.py</div>
                <pre><code><span class="string">"""Lightweight guardrails without NeMo dependency."""</span>

<span class="keyword">import</span> re
<span class="keyword">from</span> typing <span class="keyword">import</span> Optional, List
<span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass


<span class="decorator">@dataclass</span>
<span class="keyword">class</span> <span class="class-name">RailResult</span>:
    <span class="string">"""Result of a rail check."""</span>
    passed: <span class="builtin">bool</span>
    message: Optional[<span class="builtin">str</span>] = <span class="keyword">None</span>
    modified_text: Optional[<span class="builtin">str</span>] = <span class="keyword">None</span>


<span class="keyword">class</span> <span class="class-name">SimpleGuardrails</span>:
    <span class="string">"""Lightweight guardrails implementation."""</span>

    <span class="comment"># Jailbreak patterns</span>
    JAILBREAK_PATTERNS = [
        <span class="string">r"ignore (all )?(previous |prior )?instructions"</span>,
        <span class="string">r"disregard (all )?(previous |prior )?(instructions|rules)"</span>,
        <span class="string">r"you are now"</span>,
        <span class="string">r"pretend (you are|to be)"</span>,
        <span class="string">r"act as"</span>,
        <span class="string">r"DAN mode"</span>,
    ]

    <span class="comment"># Dangerous commands</span>
    BLOCKED_COMMANDS = [
        <span class="string">"rm -rf /"</span>, <span class="string">"rm -rf /*"</span>,
        <span class="string">"format c:"</span>, <span class="string">"del /f /s /q"</span>,
        <span class="string">":(){:|:&};:"</span>,  <span class="comment"># Fork bomb</span>
        <span class="string">"dd if=/dev/zero"</span>,
        <span class="string">"mkfs."</span>, <span class="string">"> /dev/sda"</span>,
    ]

    <span class="comment"># Secret patterns for redaction</span>
    SECRET_PATTERNS = [
        (<span class="string">r"(?i)(api[_-]?key|apikey)['\"]?\s*[:=]\s*['\"]?([\w\-]+)"</span>, <span class="string">r"\1=***REDACTED***"</span>),
        (<span class="string">r"(?i)(password|passwd|pwd)['\"]?\s*[:=]\s*['\"]?([^\s,}\"']+)"</span>, <span class="string">r"\1=***REDACTED***"</span>),
        (<span class="string">r"(?i)(secret|token)['\"]?\s*[:=]\s*['\"]?([\w\-]+)"</span>, <span class="string">r"\1=***REDACTED***"</span>),
        (<span class="string">r"(?i)bearer\s+([\w\-\.]+)"</span>, <span class="string">"Bearer ***REDACTED***"</span>),
        (<span class="string">r"sk-[a-zA-Z0-9]{20,}"</span>, <span class="string">"sk-***REDACTED***"</span>),
        (<span class="string">r"ghp_[a-zA-Z0-9]{36}"</span>, <span class="string">"ghp_***REDACTED***"</span>),
    ]

    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="builtin">self</span>, enabled: <span class="builtin">bool</span> = <span class="keyword">True</span>):
        <span class="builtin">self</span>.enabled = enabled

    <span class="keyword">def</span> <span class="function">check_input</span>(<span class="builtin">self</span>, text: <span class="builtin">str</span>) -> RailResult:
        <span class="string">"""Check input for safety issues."""</span>
        <span class="keyword">if</span> <span class="keyword">not</span> <span class="builtin">self</span>.enabled:
            <span class="keyword">return</span> RailResult(passed=<span class="keyword">True</span>)

        text_lower = text.lower()

        <span class="comment"># Check jailbreak</span>
        <span class="keyword">for</span> pattern <span class="keyword">in</span> <span class="builtin">self</span>.JAILBREAK_PATTERNS:
            <span class="keyword">if</span> re.search(pattern, text_lower):
                <span class="keyword">return</span> RailResult(
                    passed=<span class="keyword">False</span>,
                    message=<span class="string">"Jailbreak attempt detected. I can only help with legitimate coding tasks."</span>
                )

        <span class="comment"># Check dangerous commands</span>
        <span class="keyword">for</span> cmd <span class="keyword">in</span> <span class="builtin">self</span>.BLOCKED_COMMANDS:
            <span class="keyword">if</span> cmd.lower() <span class="keyword">in</span> text_lower:
                <span class="keyword">return</span> RailResult(
                    passed=<span class="keyword">False</span>,
                    message=<span class="string">f"Dangerous command detected. This operation is not allowed."</span>
                )

        <span class="keyword">return</span> RailResult(passed=<span class="keyword">True</span>)

    <span class="keyword">def</span> <span class="function">process_output</span>(<span class="builtin">self</span>, text: <span class="builtin">str</span>) -> RailResult:
        <span class="string">"""Process output and redact sensitive data."""</span>
        <span class="keyword">if</span> <span class="keyword">not</span> <span class="builtin">self</span>.enabled:
            <span class="keyword">return</span> RailResult(passed=<span class="keyword">True</span>, modified_text=text)

        result = text

        <span class="comment"># Redact secrets</span>
        <span class="keyword">for</span> pattern, replacement <span class="keyword">in</span> <span class="builtin">self</span>.SECRET_PATTERNS:
            result = re.sub(pattern, replacement, result)

        <span class="comment"># Remove dangerous commands from output</span>
        <span class="keyword">for</span> cmd <span class="keyword">in</span> <span class="builtin">self</span>.BLOCKED_COMMANDS:
            <span class="keyword">if</span> cmd.lower() <span class="keyword">in</span> result.lower():
                result = result.replace(cmd, <span class="string">"[BLOCKED]"</span>)

        <span class="keyword">return</span> RailResult(
            passed=<span class="keyword">True</span>,
            modified_text=result
        )


<span class="comment"># Usage in CodingAgent</span>
<span class="keyword">class</span> <span class="class-name">CodingAgentWithSimpleRails</span>:
    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="builtin">self</span>):
        <span class="builtin">self</span>.rails = SimpleGuardrails()
        <span class="comment"># ... rest of init ...</span>

    <span class="keyword">def</span> <span class="function">run</span>(<span class="builtin">self</span>, message: <span class="builtin">str</span>, stream: <span class="builtin">bool</span> = <span class="keyword">True</span>):
        <span class="comment"># Check input</span>
        input_check = <span class="builtin">self</span>.rails.check_input(message)
        <span class="keyword">if</span> <span class="keyword">not</span> input_check.passed:
            <span class="keyword">return</span> input_check.message

        <span class="comment"># Run agent</span>
        response = <span class="builtin">self</span>.agent.run(message, stream=stream)

        <span class="comment"># Process output</span>
        <span class="keyword">if</span> <span class="keyword">not</span> stream:
            output_check = <span class="builtin">self</span>.rails.process_output(response.content)
            response.content = output_check.modified_text

        <span class="keyword">return</span> response</code></pre>
            </div>
        </div>

        <!-- Interview Q&A -->
        <div class="architecture-section">
            <h2>Interview Questions About This Implementation</h2>

            <div class="interview-tip">
                <h4>Q: Why can NeMo Guardrails be integrated with Agno?</h4>
                <p><strong>A:</strong> NeMo Guardrails works at the application layer, wrapping LLM calls. It doesn't modify framework internals. Our Agno agent exposes a simple `run()` interface that we intercept before/after to apply safety checks. This is the adapter pattern - we adapt NeMo's rail system to work with Agno's execution flow.</p>
            </div>

            <div class="interview-tip">
                <h4>Q: Where are the integration points in your architecture?</h4>
                <p><strong>A:</strong> Three main points:</p>
                <ol style="margin-left: 20px; margin-top: 10px;">
                    <li><strong>Pre-LLM (Input Rails):</strong> Before `agent.run()` in CodingAgent</li>
                    <li><strong>Post-LLM (Output Rails):</strong> After response, before returning to user</li>
                    <li><strong>Tool Execution:</strong> Can wrap individual tools with permission checks</li>
                </ol>
            </div>

            <div class="interview-tip">
                <h4>Q: What patterns does this use?</h4>
                <p><strong>A:</strong></p>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li><strong>Decorator Pattern:</strong> Wrapping agent calls with guardrail checks</li>
                    <li><strong>Chain of Responsibility:</strong> Multiple rails checked in sequence</li>
                    <li><strong>Strategy Pattern:</strong> Different rail implementations (NeMo vs Simple)</li>
                    <li><strong>Singleton:</strong> Single guardrails instance via `get_guardrails()`</li>
                </ul>
            </div>

            <div class="interview-tip">
                <h4>Q: How do you handle streaming responses?</h4>
                <p><strong>A:</strong> Streaming is challenging for guardrails because we don't have the complete response. Our approach:</p>
                <ol style="margin-left: 20px; margin-top: 10px;">
                    <li>Input rails run synchronously before streaming starts</li>
                    <li>We accumulate the full response during streaming</li>
                    <li>After streaming completes, we run output rails for logging/alerting</li>
                    <li>For real-time blocking, we'd need token-level checks (more complex)</li>
                </ol>
            </div>
        </div>

        <!-- Summary -->
        <div class="success-box">
            <h3>Summary: What You Get</h3>
            <table>
                <tr>
                    <th>Protection</th>
                    <th>What It Does</th>
                </tr>
                <tr>
                    <td>Jailbreak Detection</td>
                    <td>Blocks attempts to override system instructions</td>
                </tr>
                <tr>
                    <td>Command Injection</td>
                    <td>Prevents dangerous shell commands</td>
                </tr>
                <tr>
                    <td>Path Traversal</td>
                    <td>Blocks access to sensitive system paths</td>
                </tr>
                <tr>
                    <td>Secret Redaction</td>
                    <td>Removes API keys, passwords from output</td>
                </tr>
                <tr>
                    <td>Code Safety</td>
                    <td>Warns about dangerous code patterns</td>
                </tr>
            </table>
        </div>

        <div class="warning-box">
            <h3>Important Notes</h3>
            <ul style="margin-left: 20px;">
                <li>NeMo requires Python 3.10+ and significant dependencies</li>
                <li>The lightweight version works without any external dependencies</li>
                <li>Test guardrails thoroughly before production use</li>
                <li>Keep patterns updated as new attack vectors emerge</li>
            </ul>
        </div>

        <div style="text-align: center; margin-top: 40px; color: #666;">
            <p>Code Agent - NeMo Guardrails Integration Guide</p>
            <p>Generated for Interview Preparation</p>
        </div>
    </div>
</body>
</html>
