# Code Agent - Flow Diagrams & Sequences

## 1. System Startup Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          SYSTEM STARTUP                                      │
└─────────────────────────────────────────────────────────────────────────────┘

     ┌──────────────┐
     │    User      │
     │  Runs CLI    │
     └──────┬───────┘
            │
            ▼
     ┌──────────────┐         ┌──────────────┐
     │   main.py    │────────▶│  Check Args  │
     └──────────────┘         └──────┬───────┘
                                     │
                    ┌────────────────┼────────────────┐
                    │                │                │
                    ▼                ▼                ▼
             ┌──────────┐    ┌──────────┐    ┌──────────┐
             │   cli    │    │  serve   │    │  help    │
             └────┬─────┘    └────┬─────┘    └────┬─────┘
                  │               │               │
                  ▼               ▼               ▼
           ┌───────────┐  ┌───────────┐    ┌───────────┐
           │  Load     │  │  Start    │    │  Print    │
           │ Settings  │  │  FastAPI  │    │  Usage    │
           └─────┬─────┘  └───────────┘    └───────────┘
                 │
                 ▼
           ┌───────────┐
           │  Create   │
           │  Agent    │
           └─────┬─────┘
                 │
                 ▼
           ┌───────────┐
           │ Connect   │
           │ to Ollama │
           └─────┬─────┘
                 │
                 ▼
           ┌───────────┐
           │   Load    │
           │  15 Tools │
           └─────┬─────┘
                 │
                 ▼
           ┌───────────┐
           │   Init    │
           │  SQLite   │
           └─────┬─────┘
                 │
                 ▼
           ┌───────────┐
           │   Ready   │
           │  for User │
           └───────────┘
```

---

## 2. CLI Interaction Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        CLI INTERACTION LOOP                                  │
└─────────────────────────────────────────────────────────────────────────────┘

                              ┌──────────────┐
                              │    Start     │
                              └──────┬───────┘
                                     │
                                     ▼
                    ┌────────────────────────────────┐
              ┌────▶│  Display Prompt & Wait Input   │◀────┐
              │     └────────────────┬───────────────┘     │
              │                      │                     │
              │                      ▼                     │
              │     ┌────────────────────────────────┐     │
              │     │      Parse User Input          │     │
              │     └────────────────┬───────────────┘     │
              │                      │                     │
              │      ┌───────────────┼───────────────┐     │
              │      │               │               │     │
              │      ▼               ▼               ▼     │
              │ ┌─────────┐   ┌───────────┐   ┌─────────┐ │
              │ │ Command │   │ Natural   │   │  Exit   │ │
              │ │ (/help) │   │ Language  │   │ (/exit) │ │
              │ └────┬────┘   └─────┬─────┘   └────┬────┘ │
              │      │              │              │       │
              │      ▼              ▼              ▼       │
              │ ┌─────────┐   ┌───────────┐   ┌─────────┐ │
              │ │ Handle  │   │   Send    │   │  Exit   │ │
              │ │ Command │   │ to Agent  │   │ Program │ │
              │ └────┬────┘   └─────┬─────┘   └─────────┘ │
              │      │              │                     │
              │      │              ▼                     │
              │      │        ┌───────────┐               │
              │      │        │  Stream   │               │
              │      │        │ Response  │               │
              │      │        └─────┬─────┘               │
              │      │              │                     │
              │      └──────────────┴─────────────────────┘
              │
              └──────────────────────────────────────────────
```

---

## 3. Agent Processing Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       AGENT PROCESSING FLOW                                  │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────┐
  │ User Query  │
  │  "List all  │
  │ Python files│
  └──────┬──────┘
         │
         ▼
  ┌─────────────────────────────────────────────────────────────┐
  │                    CODING AGENT                              │
  ├─────────────────────────────────────────────────────────────┤
  │                                                              │
  │  1. Receive Message                                          │
  │     ┌─────────────────────────────────────────────────┐     │
  │     │ • Load conversation history                      │     │
  │     │ • Add system instructions                        │     │
  │     │ • Prepare context with datetime                  │     │
  │     └─────────────────────────────────────────────────┘     │
  │                          │                                   │
  │                          ▼                                   │
  │  2. Send to LLM (Ollama)                                     │
  │     ┌─────────────────────────────────────────────────┐     │
  │     │ • Full context + user message                    │     │
  │     │ • Available tools schema                         │     │
  │     │ • Model: gpt-oss:20b                            │     │
  │     └─────────────────────────────────────────────────┘     │
  │                          │                                   │
  │                          ▼                                   │
  │  3. LLM Decision                                             │
  │     ┌─────────────────────────────────────────────────┐     │
  │     │ Response Type:                                   │     │
  │     │ ┌─────────────┐  ┌─────────────┐                │     │
  │     │ │ Tool Call   │  │ Direct      │                │     │
  │     │ │ Required    │  │ Response    │                │     │
  │     │ └──────┬──────┘  └──────┬──────┘                │     │
  │     └────────┼────────────────┼───────────────────────┘     │
  │              │                │                              │
  │              ▼                │                              │
  │  4. Execute Tool (if needed)  │                              │
  │     ┌─────────────────────┐   │                              │
  │     │ find_files("*.py")  │   │                              │
  │     └──────────┬──────────┘   │                              │
  │                │              │                              │
  │                ▼              │                              │
  │     ┌─────────────────────┐   │                              │
  │     │ Tool Result:        │   │                              │
  │     │ [file1.py, ...]     │   │                              │
  │     └──────────┬──────────┘   │                              │
  │                │              │                              │
  │                ▼              │                              │
  │  5. Generate Final Response   │                              │
  │     ┌─────────────────────┐   │                              │
  │     │ LLM formats result  │◀──┘                              │
  │     │ for human reading   │                                  │
  │     └──────────┬──────────┘                                  │
  │                │                                             │
  └────────────────┼─────────────────────────────────────────────┘
                   │
                   ▼
  ┌─────────────────────────────────────────────────────────────┐
  │  "Here are the Python files in the project:                  │
  │   - src/main.py                                              │
  │   - src/utils.py                                             │
  │   ..."                                                       │
  └─────────────────────────────────────────────────────────────┘
```

---

## 4. Tool Execution Detail Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      TOOL EXECUTION DETAIL                                   │
└─────────────────────────────────────────────────────────────────────────────┘

          ┌───────────────────┐
          │  LLM Requests     │
          │  Tool: find_files │
          │  Args: {          │
          │    pattern:"*.py" │
          │  }                │
          └─────────┬─────────┘
                    │
                    ▼
          ┌───────────────────┐
          │ Agno Framework    │
          │ Parses Tool Call  │
          └─────────┬─────────┘
                    │
                    ▼
          ┌───────────────────┐
          │ Locate Tool       │
          │ find_files in     │
          │ SEARCH_TOOLS      │
          └─────────┬─────────┘
                    │
                    ▼
          ┌───────────────────┐
          │ Validate Args     │
          │ pattern: string ✓ │
          └─────────┬─────────┘
                    │
                    ▼
          ┌───────────────────┐
          │ Execute           │
          │ find_files.       │
          │ entrypoint(       │
          │   pattern="*.py"  │
          │ )                 │
          └─────────┬─────────┘
                    │
                    ▼
    ┌───────────────────────────────────────┐
    │         TOOL IMPLEMENTATION           │
    ├───────────────────────────────────────┤
    │                                       │
    │  def find_files(pattern, ...):        │
    │      search_dir = get_working_dir()   │
    │      results = []                     │
    │                                       │
    │      for root, dirs, files in walk(): │
    │          # Skip ignored dirs          │
    │          # Match pattern              │
    │          # Collect results            │
    │                                       │
    │      return formatted_output          │
    │                                       │
    └───────────────────┬───────────────────┘
                        │
                        ▼
          ┌───────────────────┐
          │ Tool Result       │
          │ "Find: '*.py'     │
          │  Found: 19 files  │
          │  src/__init__.py  │
          │  src/cli.py       │
          │  ..."             │
          └─────────┬─────────┘
                    │
                    ▼
          ┌───────────────────┐
          │ Return to LLM     │
          │ for Response      │
          │ Generation        │
          └───────────────────┘
```

---

## 5. Multi-Tool Sequence Example

```
┌─────────────────────────────────────────────────────────────────────────────┐
│         MULTI-TOOL SEQUENCE: "Create a hello world Python file"             │
└─────────────────────────────────────────────────────────────────────────────┘

User: "Create a hello.py file that prints hello world"
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ STEP 1: LLM Analyzes Request                                                 │
│ ────────────────────────────────────────────────────────────────────────── │
│ Intent: Create a new file with specific content                             │
│ Required Tool: create_file                                                   │
│ Arguments: file_path="hello.py", content="print('Hello World')"             │
└─────────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ STEP 2: Tool Call - create_file                                              │
│ ────────────────────────────────────────────────────────────────────────── │
│ create_file.entrypoint(                                                      │
│     file_path="hello.py",                                                    │
│     content="print('Hello World')"                                           │
│ )                                                                            │
│                                                                              │
│ Execution:                                                                   │
│ 1. Resolve path: D:\code-agent\hello.py                                      │
│ 2. Check if exists: No                                                       │
│ 3. Write content to file                                                     │
│ 4. Return: "Successfully created file: D:\code-agent\hello.py"               │
└─────────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ STEP 3: LLM Generates Response                                               │
│ ────────────────────────────────────────────────────────────────────────── │
│ Input: Tool result "Successfully created file..."                            │
│ Output:                                                                      │
│   "I've created hello.py with a hello world program.                         │
│    You can run it with: python hello.py"                                     │
└─────────────────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ RESULT DISPLAYED TO USER                                                     │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Complex Multi-Tool Example

```
┌─────────────────────────────────────────────────────────────────────────────┐
│   COMPLEX SEQUENCE: "Find all TODO comments and save to a file"             │
└─────────────────────────────────────────────────────────────────────────────┘

User: "Find all TODO comments in Python files and save them to todos.txt"

         │
         ▼
┌─────────────────┐
│ LLM Planning    │
│ ─────────────── │
│ Need 2 tools:   │
│ 1. search_files │
│ 2. write_file   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌─────────────────────────────────────┐
│ TOOL CALL 1     │     │ search_files(                       │
│ search_files    │────▶│   pattern="TODO",                   │
└─────────────────┘     │   file_pattern="*.py"               │
                        │ )                                   │
                        └──────────────────┬──────────────────┘
                                           │
                                           ▼
                        ┌─────────────────────────────────────┐
                        │ Result:                             │
                        │ src/main.py:42: # TODO: Add logging │
                        │ src/utils.py:15: # TODO: Optimize   │
                        │ tests/test.py:8: # TODO: Add tests  │
                        └──────────────────┬──────────────────┘
                                           │
                                           ▼
┌─────────────────┐     ┌─────────────────────────────────────┐
│ TOOL CALL 2     │     │ write_file(                         │
│ write_file      │────▶│   file_path="todos.txt",            │
└─────────────────┘     │   content="TODO List:\n..."         │
                        │ )                                   │
                        └──────────────────┬──────────────────┘
                                           │
                                           ▼
                        ┌─────────────────────────────────────┐
                        │ Result:                             │
                        │ "Successfully created todos.txt"    │
                        └──────────────────┬──────────────────┘
                                           │
                                           ▼
                        ┌─────────────────────────────────────┐
                        │ Final Response to User:             │
                        │ "I found 3 TODO comments and saved  │
                        │  them to todos.txt"                 │
                        └─────────────────────────────────────┘
```

---

## 7. API Server Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         API SERVER FLOW                                      │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌───────────────────┐
                    │   Client App      │
                    │   (Web/Mobile)    │
                    └─────────┬─────────┘
                              │
              ┌───────────────┼───────────────┐
              │               │               │
              ▼               ▼               ▼
       ┌────────────┐  ┌────────────┐  ┌────────────┐
       │  REST API  │  │ WebSocket  │  │  REST API  │
       │ POST /chat │  │ /ws/{id}   │  │ GET /health│
       └──────┬─────┘  └──────┬─────┘  └──────┬─────┘
              │               │               │
              ▼               ▼               ▼
       ┌────────────────────────────────────────────┐
       │              FastAPI Router                 │
       └───────────────────┬────────────────────────┘
                           │
                           ▼
       ┌────────────────────────────────────────────┐
       │           Session Manager                   │
       │  ┌──────────────────────────────────────┐  │
       │  │ sessions = {                          │  │
       │  │   "uuid-1": CodingAgent(...),        │  │
       │  │   "uuid-2": CodingAgent(...),        │  │
       │  │ }                                     │  │
       │  └──────────────────────────────────────┘  │
       └───────────────────┬────────────────────────┘
                           │
                           ▼
       ┌────────────────────────────────────────────┐
       │              Coding Agent                   │
       │         (Process Request)                   │
       └───────────────────┬────────────────────────┘
                           │
              ┌────────────┴────────────┐
              │                         │
              ▼                         ▼
       ┌────────────┐           ┌────────────┐
       │  Streaming │           │   Single   │
       │  Response  │           │  Response  │
       │ (WebSocket)│           │   (REST)   │
       └────────────┘           └────────────┘
```

---

## 8. WebSocket Message Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       WEBSOCKET MESSAGE FLOW                                 │
└─────────────────────────────────────────────────────────────────────────────┘

Client                                                              Server
  │                                                                    │
  │  ──────────── CONNECT ws://localhost:8000/ws/session-123 ────────▶ │
  │                                                                    │
  │  ◀──────────────────── CONNECTION ACCEPTED ─────────────────────── │
  │                                                                    │
  │  ─────────────────────────────────────────────────────────────────▶ │
  │  {                                                                 │
  │    "type": "message",                                              │
  │    "content": "List Python files"                                  │
  │  }                                                                 │
  │                                                                    │
  │  ◀───────────────────────────────────────────────────────────────── │
  │  {"type": "chunk", "content": "I'll search for"}                   │
  │                                                                    │
  │  ◀───────────────────────────────────────────────────────────────── │
  │  {"type": "tool_call", "name": "find_files", "args": {...}}        │
  │                                                                    │
  │  ◀───────────────────────────────────────────────────────────────── │
  │  {"type": "chunk", "content": " Python files..."}                  │
  │                                                                    │
  │  ◀───────────────────────────────────────────────────────────────── │
  │  {"type": "chunk", "content": "\n- main.py\n- utils.py"}           │
  │                                                                    │
  │  ◀───────────────────────────────────────────────────────────────── │
  │  {"type": "done"}                                                  │
  │                                                                    │
  │  ─────────────────────────────────────────────────────────────────▶ │
  │  {"type": "ping"}                                                  │
  │                                                                    │
  │  ◀───────────────────────────────────────────────────────────────── │
  │  {"type": "pong"}                                                  │
  │                                                                    │
```

---

## 9. Error Handling Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        ERROR HANDLING FLOW                                   │
└─────────────────────────────────────────────────────────────────────────────┘

User Request
     │
     ▼
┌────────────────┐
│ Process Input  │
└───────┬────────┘
        │
        ▼
   ┌─────────┐      ┌─────────────────────────────┐
   │ Valid?  │──No─▶│ Return: "Invalid request"   │
   └────┬────┘      └─────────────────────────────┘
        │Yes
        ▼
┌────────────────┐
│  Send to LLM   │
└───────┬────────┘
        │
        ▼
   ┌─────────┐      ┌─────────────────────────────┐
   │Ollama OK│──No─▶│ Return: "LLM unavailable"   │
   └────┬────┘      └─────────────────────────────┘
        │Yes
        ▼
┌────────────────┐
│ Execute Tools  │
└───────┬────────┘
        │
        ▼
   ┌─────────┐      ┌─────────────────────────────┐
   │Tool OK? │──No─▶│ LLM receives error message  │
   └────┬────┘      │ LLM explains error to user  │
        │Yes        └─────────────────────────────┘
        ▼
┌────────────────┐
│Generate Result │
└───────┬────────┘
        │
        ▼
   ┌─────────┐      ┌─────────────────────────────┐
   │Timeout? │─Yes─▶│ Return: "Operation timeout" │
   └────┬────┘      └─────────────────────────────┘
        │No
        ▼
┌────────────────┐
│ Return Success │
└────────────────┘
```

---

## 10. Session Persistence Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      SESSION PERSISTENCE FLOW                                │
└─────────────────────────────────────────────────────────────────────────────┘

     ┌─────────────────────────────────────────────────────────────────┐
     │                    AGENT INITIALIZATION                          │
     └──────────────────────────────┬──────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │  SqliteDb(db_file="data/agent_storage.db")                       │
     │  ┌─────────────────────────────────────────────────────────┐    │
     │  │ Tables Created:                                          │    │
     │  │ • sessions (id, created_at, metadata)                    │    │
     │  │ • messages (session_id, role, content, timestamp)        │    │
     │  │ • tool_calls (session_id, tool_name, args, result)       │    │
     │  └─────────────────────────────────────────────────────────┘    │
     └──────────────────────────────┬──────────────────────────────────┘
                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    ON EACH MESSAGE                               │
     └──────────────────────────────┬──────────────────────────────────┘
                                    │
         ┌──────────────────────────┼──────────────────────────┐
         │                          │                          │
         ▼                          ▼                          ▼
┌─────────────────┐    ┌─────────────────────┐    ┌─────────────────┐
│  Load History   │    │   Process Message   │    │   Save Result   │
│  from SQLite    │───▶│   with Context      │───▶│   to SQLite     │
└─────────────────┘    └─────────────────────┘    └─────────────────┘

                                    │
                                    ▼
     ┌─────────────────────────────────────────────────────────────────┐
     │                    SESSION RESUME                                │
     │  ────────────────────────────────────────────────────────────── │
     │  When agent starts with same session_id:                        │
     │  1. Load existing session from SQLite                           │
     │  2. Restore conversation history                                │
     │  3. Continue where left off                                     │
     └─────────────────────────────────────────────────────────────────┘
```

---

## Summary Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    CODE AGENT - COMPLETE SYSTEM FLOW                         │
└─────────────────────────────────────────────────────────────────────────────┘

  USER                CLI/API              AGENT                 LLM
   │                    │                    │                    │
   │  "Find Python"     │                    │                    │
   │───────────────────▶│                    │                    │
   │                    │  agent.run(msg)    │                    │
   │                    │───────────────────▶│                    │
   │                    │                    │  chat(context)     │
   │                    │                    │───────────────────▶│
   │                    │                    │                    │
   │                    │                    │◀──tool_call────────│
   │                    │                    │  find_files()      │
   │                    │                    │────────────────────│
   │                    │                    │  [results]         │
   │                    │                    │───────────────────▶│
   │                    │                    │                    │
   │                    │                    │◀──response─────────│
   │                    │◀──────────────────│                    │
   │◀──────────────────│                    │                    │
   │  "Found: ..."      │                    │                    │
   │                    │                    │                    │
```
