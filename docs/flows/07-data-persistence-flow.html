<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Persistence Flow - Code Agent</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        :root {
            --primary: #a855f7;
            --primary-glow: rgba(168, 85, 247, 0.4);
            --secondary: #06b6d4;
            --sqlite: #3b82f6;
            --json: #22c55e;
            --filesystem: #f59e0b;
            --bg-dark: #030712;
            --bg-card: rgba(15, 23, 42, 0.8);
            --bg-glass: rgba(255, 255, 255, 0.03);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border: rgba(148, 163, 184, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background:
                radial-gradient(circle at 30% 70%, rgba(168, 85, 247, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 70% 30%, rgba(6, 182, 212, 0.08) 0%, transparent 50%);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 60px;
        }

        .header-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-glass);
            border: 1px solid var(--primary);
            padding: 8px 20px;
            border-radius: 50px;
            font-size: 0.85rem;
            color: var(--primary);
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 3.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #a855f7 0%, #06b6d4 50%, #22c55e 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
        }

        .header p {
            font-size: 1.25rem;
            color: var(--text-secondary);
            max-width: 700px;
            margin: 0 auto;
        }

        /* Storage Types Grid */
        .storage-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            margin-bottom: 60px;
        }

        .storage-card {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 24px;
            padding: 35px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .storage-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.3);
        }

        .storage-card.sqlite:hover { border-color: var(--sqlite); }
        .storage-card.json:hover { border-color: var(--json); }
        .storage-card.filesystem:hover { border-color: var(--filesystem); }

        .storage-icon {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            margin: 0 auto 20px;
        }

        .storage-card.sqlite .storage-icon { background: linear-gradient(135deg, var(--sqlite), #2563eb); }
        .storage-card.json .storage-icon { background: linear-gradient(135deg, var(--json), #16a34a); }
        .storage-card.filesystem .storage-icon { background: linear-gradient(135deg, var(--filesystem), #d97706); }

        .storage-card h3 {
            font-size: 1.4rem;
            margin-bottom: 10px;
        }

        .storage-card .purpose {
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .storage-features {
            text-align: left;
        }

        .storage-features li {
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .storage-features li:last-child {
            border-bottom: none;
        }

        .storage-features li::before {
            content: '‚ñ∏';
            color: var(--primary);
        }

        /* Data Flow Diagram */
        .data-flow {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 40px;
            margin-bottom: 60px;
        }

        .data-flow h2 {
            text-align: center;
            margin-bottom: 40px;
            font-size: 1.8rem;
        }

        .flow-diagram {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .flow-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .flow-node {
            background: var(--bg-glass);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 20px 30px;
            text-align: center;
            min-width: 160px;
            transition: all 0.3s ease;
        }

        .flow-node:hover {
            transform: scale(1.05);
        }

        .flow-node.agent { border-color: var(--primary); background: rgba(168, 85, 247, 0.1); }
        .flow-node.sqlite { border-color: var(--sqlite); }
        .flow-node.json { border-color: var(--json); }
        .flow-node.file { border-color: var(--filesystem); }

        .flow-node .icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .flow-node h4 {
            font-size: 0.95rem;
            margin-bottom: 5px;
        }

        .flow-node span {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .flow-arrow {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .flow-arrow-down {
            font-size: 2rem;
            color: var(--primary);
        }

        /* File Structure */
        .file-structure {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 40px;
            margin-bottom: 60px;
        }

        .file-structure h2 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.8rem;
        }

        .structure-code {
            background: #0d1117;
            border-radius: 16px;
            padding: 30px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            line-height: 1.8;
            overflow-x: auto;
        }

        .structure-code .folder { color: #79c0ff; }
        .structure-code .file { color: #8b949e; }
        .structure-code .sqlite { color: var(--sqlite); }
        .structure-code .json { color: var(--json); }
        .structure-code .comment { color: #6e7681; font-style: italic; }

        /* Checkpoint System */
        .checkpoint-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 60px;
        }

        .checkpoint-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            overflow: hidden;
        }

        .checkpoint-header {
            padding: 25px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 15px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), transparent);
        }

        .checkpoint-header .icon {
            width: 50px;
            height: 50px;
            background: var(--primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .checkpoint-header h3 {
            font-size: 1.2rem;
        }

        .checkpoint-body {
            padding: 25px;
        }

        .checkpoint-body p {
            color: var(--text-secondary);
            margin-bottom: 20px;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .code-block {
            background: #0d1117;
            border-radius: 12px;
            padding: 20px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            overflow-x: auto;
            line-height: 1.7;
        }

        .code-block .keyword { color: #ff7b72; }
        .code-block .class { color: #ffa657; }
        .code-block .string { color: #a5d6ff; }
        .code-block .comment { color: #8b949e; }
        .code-block .function { color: #d2a8ff; }

        /* Safety Features */
        .safety-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 60px;
        }

        .safety-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 30px;
            transition: all 0.3s ease;
        }

        .safety-card:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
        }

        .safety-card h4 {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .safety-card h4 span {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .safety-card p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        /* Interview Section */
        .interview-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 40px;
        }

        .interview-section h2 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary);
        }

        .qa-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .qa-item {
            background: var(--bg-glass);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px;
        }

        .qa-item h4 {
            color: #f472b6;
            margin-bottom: 12px;
            font-size: 1rem;
        }

        .qa-item p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.7;
        }

        .footer {
            text-align: center;
            margin-top: 60px;
            padding: 30px;
            border-top: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .footer a {
            color: var(--primary);
            text-decoration: none;
        }

        @media (max-width: 900px) {
            .header h1 { font-size: 2.5rem; }
            .storage-grid { grid-template-columns: 1fr; }
            .checkpoint-section { grid-template-columns: 1fr; }
            .flow-row { flex-direction: column; }
            .flow-arrow { transform: rotate(90deg); }
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>

    <div class="container">
        <header class="header">
            <div class="header-badge">üíæ DATA PERSISTENCE</div>
            <h1>Data Persistence Flow</h1>
            <p>How Code Agent stores sessions, memory, checkpoints, and enables undo/redo</p>
        </header>

        <!-- Storage Types -->
        <section class="storage-grid">
            <div class="storage-card sqlite">
                <div class="storage-icon">üóÑÔ∏è</div>
                <h3>SQLite Database</h3>
                <p class="purpose">Session & conversation storage</p>
                <ul class="storage-features">
                    <li>Session state via Agno framework</li>
                    <li>Message history per session</li>
                    <li>Tool call records</li>
                    <li>User preferences</li>
                    <li>Fast queries, ACID compliant</li>
                </ul>
            </div>

            <div class="storage-card json">
                <div class="storage-icon">üìã</div>
                <h3>JSON Files</h3>
                <p class="purpose">Structured data & long-term memory</p>
                <ul class="storage-features">
                    <li>Memory entries per project</li>
                    <li>Plans and workflows</li>
                    <li>Checkpoints metadata</li>
                    <li>Plugin configurations</li>
                    <li>Human-readable, easy to debug</li>
                </ul>
            </div>

            <div class="storage-card filesystem">
                <div class="storage-icon">üìÅ</div>
                <h3>File System</h3>
                <p class="purpose">Checkpoints & file snapshots</p>
                <ul class="storage-features">
                    <li>Full file backups before changes</li>
                    <li>Incremental change history</li>
                    <li>Undo/redo state</li>
                    <li>Named checkpoint snapshots</li>
                    <li>Project isolation</li>
                </ul>
            </div>
        </section>

        <!-- Data Flow Diagram -->
        <section class="data-flow">
            <h2>üîÑ Data Flow Architecture</h2>

            <div class="flow-diagram">
                <div class="flow-row">
                    <div class="flow-node agent">
                        <div class="icon">üß†</div>
                        <h4>CodingAgent</h4>
                        <span>Orchestrator</span>
                    </div>
                </div>

                <div class="flow-arrow-down">‚Üì</div>

                <div class="flow-row">
                    <div class="flow-node sqlite">
                        <div class="icon">üóÑÔ∏è</div>
                        <h4>SQLite</h4>
                        <span>agent_storage.db</span>
                    </div>
                    <div class="flow-arrow">‚Üî</div>
                    <div class="flow-node json">
                        <div class="icon">üìã</div>
                        <h4>JSON</h4>
                        <span>memory/entries.json</span>
                    </div>
                    <div class="flow-arrow">‚Üî</div>
                    <div class="flow-node file">
                        <div class="icon">üìÅ</div>
                        <h4>File System</h4>
                        <span>checkpoints/</span>
                    </div>
                </div>

                <div class="flow-arrow-down">‚Üì</div>

                <div class="flow-row">
                    <div class="flow-node">
                        <div class="icon">üí¨</div>
                        <h4>Sessions</h4>
                        <span>Conversations</span>
                    </div>
                    <div class="flow-node">
                        <div class="icon">üß†</div>
                        <h4>Memory</h4>
                        <span>Learning</span>
                    </div>
                    <div class="flow-node">
                        <div class="icon">üì∏</div>
                        <h4>Snapshots</h4>
                        <span>Recovery</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- File Structure -->
        <section class="file-structure">
            <h2>üìÇ Storage Directory Structure</h2>

            <div class="structure-code">
<span class="folder">data/</span>
‚îú‚îÄ‚îÄ <span class="sqlite">agent_storage.db</span>       <span class="comment"># SQLite - Sessions, messages, tool calls</span>
‚îú‚îÄ‚îÄ <span class="folder">memory/</span>
‚îÇ   ‚îî‚îÄ‚îÄ <span class="folder">{project_hash}/</span>      <span class="comment"># MD5 hash of workspace path</span>
‚îÇ       ‚îú‚îÄ‚îÄ <span class="json">entries.json</span>      <span class="comment"># Long-term memory entries</span>
‚îÇ       ‚îî‚îÄ‚îÄ <span class="json">summaries.json</span>    <span class="comment"># Conversation summaries</span>
‚îú‚îÄ‚îÄ <span class="folder">checkpoints/</span>
‚îÇ   ‚îî‚îÄ‚îÄ <span class="folder">{project_hash}/</span>
‚îÇ       ‚îú‚îÄ‚îÄ <span class="json">manifest.json</span>     <span class="comment"># Checkpoint metadata</span>
‚îÇ       ‚îî‚îÄ‚îÄ <span class="folder">snapshots/</span>        <span class="comment"># File backups</span>
‚îÇ           ‚îú‚îÄ‚îÄ <span class="file">1703849234_auth.py</span>
‚îÇ           ‚îî‚îÄ‚îÄ <span class="file">1703849300_config.py</span>
‚îú‚îÄ‚îÄ <span class="folder">plans/</span>
‚îÇ   ‚îî‚îÄ‚îÄ <span class="json">plan_abc123.json</span>     <span class="comment"># Saved execution plans</span>
‚îú‚îÄ‚îÄ <span class="folder">workflows/</span>
‚îÇ   ‚îî‚îÄ‚îÄ <span class="json">workflow_xyz.json</span>    <span class="comment"># Saved workflows</span>
‚îî‚îÄ‚îÄ <span class="folder">plugins/</span>
    ‚îî‚îÄ‚îÄ <span class="json">config.json</span>           <span class="comment"># Plugin configurations</span>
            </div>
        </section>

        <!-- Checkpoint System -->
        <section class="checkpoint-section">
            <div class="checkpoint-card">
                <div class="checkpoint-header">
                    <div class="icon">üì∏</div>
                    <h3>Checkpoint System</h3>
                </div>
                <div class="checkpoint-body">
                    <p>Automatically creates file snapshots before risky operations. Enables full state restoration if something goes wrong.</p>
                    <div class="code-block">
<pre><span class="keyword">class</span> <span class="class">CheckpointManager</span>:
    <span class="keyword">def</span> <span class="function">create_checkpoint</span>(self, name: str):
        <span class="string">"""Snapshot current file state."""</span>
        timestamp = time.time()
        <span class="keyword">for</span> file <span class="keyword">in</span> self.tracked_files:
            self.<span class="function">backup_file</span>(file, timestamp)
        self.<span class="function">save_manifest</span>(name, timestamp)

    <span class="keyword">def</span> <span class="function">restore_checkpoint</span>(self, name: str):
        <span class="string">"""Restore files to checkpoint state."""</span>
        manifest = self.<span class="function">load_manifest</span>(name)
        <span class="keyword">for</span> file, backup <span class="keyword">in</span> manifest.files:
            self.<span class="function">restore_file</span>(file, backup)</pre>
                    </div>
                </div>
            </div>

            <div class="checkpoint-card">
                <div class="checkpoint-header">
                    <div class="icon">‚Ü©Ô∏è</div>
                    <h3>Undo/Redo System</h3>
                </div>
                <div class="checkpoint-body">
                    <p>Tracks all file operations for reversible changes. Supports grouped operations (multi-file edits as single undo).</p>
                    <div class="code-block">
<pre><span class="keyword">class</span> <span class="class">UndoRedoManager</span>:
    <span class="keyword">def</span> <span class="function">record_change</span>(self, operation: FileOp):
        <span class="string">"""Record operation for undo."""</span>
        self.undo_stack.append(operation)
        self.redo_stack.clear()

    <span class="keyword">def</span> <span class="function">undo</span>(self):
        <span class="string">"""Reverse last operation."""</span>
        op = self.undo_stack.pop()
        op.<span class="function">reverse</span>()
        self.redo_stack.append(op)

    <span class="keyword">def</span> <span class="function">redo</span>(self):
        <span class="string">"""Reapply undone operation."""</span>
        op = self.redo_stack.pop()
        op.<span class="function">apply</span>()
        self.undo_stack.append(op)</pre>
                    </div>
                </div>
            </div>
        </section>

        <!-- Safety Features -->
        <section>
            <h2 style="text-align: center; margin-bottom: 30px; font-size: 1.8rem;">üõ°Ô∏è Data Safety Features</h2>
            <div class="safety-grid">
                <div class="safety-card">
                    <h4><span>üîê</span> Project Isolation</h4>
                    <p>Each project gets its own storage using MD5 hash of workspace path. No data leaks between projects.</p>
                </div>
                <div class="safety-card">
                    <h4><span>üì∏</span> Auto-Checkpoint</h4>
                    <p>Automatically creates checkpoints before risky operations like file edits or command execution.</p>
                </div>
                <div class="safety-card">
                    <h4><span>üîÑ</span> Atomic Writes</h4>
                    <p>JSON files written atomically (write to temp, then rename) to prevent corruption on crash.</p>
                </div>
                <div class="safety-card">
                    <h4><span>üö´</span> Secret Exclusion</h4>
                    <p>Sensitive files (.env, credentials) excluded from checkpoints and memory by pattern matching.</p>
                </div>
                <div class="safety-card">
                    <h4><span>üíæ</span> SQLite WAL Mode</h4>
                    <p>Write-ahead logging for concurrent access and crash recovery. Database stays consistent.</p>
                </div>
                <div class="safety-card">
                    <h4><span>üóëÔ∏è</span> Cleanup Policy</h4>
                    <p>Old checkpoints and memory entries can be pruned to manage disk space while keeping important data.</p>
                </div>
            </div>
        </section>

        <!-- Interview Section -->
        <section class="interview-section">
            <h2>üéØ Interview Key Points</h2>

            <div class="qa-grid">
                <div class="qa-item">
                    <h4>Q: Why use multiple storage types?</h4>
                    <p><strong>Right tool for the job.</strong> SQLite excels at structured queries (sessions, messages). JSON is human-readable and version-control friendly (memory, configs). File system is best for large file backups (checkpoints). Each storage type optimized for its use case.</p>
                </div>
                <div class="qa-item">
                    <h4>Q: How does project isolation work?</h4>
                    <p><strong>MD5 hash of workspace path.</strong> When you work in /projects/myapp, we hash that path to create a unique project ID. All data (memory, checkpoints) goes under data/{hash}/. Different workspaces never see each other's data.</p>
                </div>
                <div class="qa-item">
                    <h4>Q: What happens if the app crashes mid-write?</h4>
                    <p><strong>Atomic writes and WAL mode.</strong> JSON files are written to a temp file first, then renamed (atomic on most filesystems). SQLite uses WAL mode which survives crashes. Checkpoints are self-contained snapshots that can be restored.</p>
                </div>
                <div class="qa-item">
                    <h4>Q: How does undo/redo work?</h4>
                    <p><strong>Operation stack pattern.</strong> Each file change is recorded as an operation object with apply() and reverse() methods. Undo pops from undo stack, reverses, pushes to redo. Grouped operations (like refactoring multiple files) undo as a single unit.</p>
                </div>
            </div>
        </section>

        <footer class="footer">
            <p>Data Persistence Flow ‚Ä¢ Code Agent Architecture</p>
            <p style="margin-top: 10px;"><a href="index.html">‚Üê Back to Index</a></p>
        </footer>
    </div>
</body>
</html>
